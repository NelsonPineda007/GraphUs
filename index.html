<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphUs - Creación de diagramas ER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="icon/icon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round:wght@400&display=swap" rel="stylesheet">
    <style>
        /* Estilos originales del sidebar */
        .sidebar-collapsed {
            width: 5rem;
        }

        .sidebar-expanded {
            width: 16rem;
        }

        .panel-collapsed {
            width: 0;
            opacity: 0;
        }

        .panel-expanded {
            width: 20rem;
            opacity: 1;
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .nav-option {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-text {
            transition: all 0.3s ease;
            white-space: nowrap;
            display: inline-block;
            min-width: max-content;
        }

        .sidebar-collapsed .nav-text {
            opacity: 0;
            transform: translateX(-10px);
            width: 0;
            margin-left: 0;
            margin-right: 0;
        }

        .sidebar-expanded .nav-text {
            opacity: 1;
            transform: translateX(0);
            width: auto;
            margin-left: 0.75rem;
        }

        .nav-icon-container {
            min-width: 2.25rem;
            transition: all 0.3s ease;
        }

        .sidebar-collapsed .nav-icon-container {
            margin-right: 0 !important;
        }

        .tooltip {
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 0.5rem;
            background: rgba(15, 23, 42, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 50;
            backdrop-filter: blur(8px);
            pointer-events: none;
        }

        .tooltip::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -4px;
            transform: translateY(-50%);
            border: 4px solid transparent;
            border-right-color: rgba(15, 23, 42, 0.9);
        }

        .sidebar-collapsed .nav-option:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        .selected-option {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left: 4px solid #6366f1;
        }

        /* Sistema de Toasts */
        :root {
            --toast-help-primary: #05478a;
            --toast-help-secondary: #0070e0;
            --toast-success-primary: #005e38;
            --toast-success-secondary: #03a65a;
            --toast-warning-primary: #c24914;
            --toast-warning-secondary: #fc8621;
            --toast-error-primary: #851d41;
            --toast-error-secondary: #db3056;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 400px;
        }

        .toast-item {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform: translateX(100%);
            margin-bottom: 0;
        }

        .toast-item.show {
            max-height: 200px;
            opacity: 1;
            transform: translateX(0);
            margin-bottom: 10px;
        }

        .toast-item.removing {
            max-height: 0;
            opacity: 0;
            transform: translateX(100%);
            margin-bottom: 0;
        }

        .toast {
            background: var(--toast-bg);
            color: #f5f5f5;
            padding: 1rem 2rem 1rem 6rem;
            border-radius: 20px;
            position: relative;
            font-family: "Varela Round", sans-serif;
            font-weight: 400;
            text-align: left;
            min-width: 280px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Decoración de gotas animada */
        .toast::before {
            content: "";
            position: absolute;
            width: 5.5rem;
            height: 6rem;
            background:
                radial-gradient(circle at 22% 3.8rem, var(--toast-primary) 0.75rem, transparent calc(0.75rem + 1px)),
                radial-gradient(circle at 95% 1.9rem, var(--toast-primary) 0.07rem, transparent calc(0.07rem + 1px)),
                radial-gradient(circle at 80% 2.25rem, var(--toast-primary) 0.18rem, transparent calc(0.18rem + 1px)),
                radial-gradient(circle at 80% 75%, var(--toast-primary) 0.35rem, transparent calc(0.35rem + 1px)),
                radial-gradient(circle at 43% 2.3rem, var(--toast-primary) 0.07rem, transparent calc(0.07rem + 1px)),
                radial-gradient(circle at 40% 1rem, var(--toast-primary) 0.12rem, transparent calc(0.12rem + 1px)),
                radial-gradient(circle at 20% 1.5rem, var(--toast-primary) 0.25rem, transparent calc(0.25rem + 1px)),
                radial-gradient(circle at 64% 51%, var(--toast-primary) 0.45rem, transparent calc(0.45rem + 1px)),
                radial-gradient(circle at 0% 120%, var(--toast-primary) 4rem, transparent calc(4rem + 1px));
            background-repeat: no-repeat;
            bottom: 0;
            left: 0;
            border-radius: 0 0 0 20px;
            opacity: 0.6;
        }

        /* Icono circular */
        .toast::after {
            content: var(--toast-icon);
            position: absolute;
            width: 3.5rem;
            height: 3.5rem;
            background: var(--toast-primary);
            top: -1.75rem;
            left: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .toast h3 {
            font-size: 1.2rem;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
            position: relative;
            color: #ffffff;
        }

        .toast p {
            font-size: 0.95rem;
            margin: 0;
            line-height: 1.4;
            color: rgba(255, 255, 255, 0.9);
        }

        .toast-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Tipos de toast */
        .toast.help {
            --toast-primary: var(--toast-help-primary);
            --toast-bg: var(--toast-help-secondary);
            --toast-icon: "?";
        }

        .toast.success {
            --toast-primary: var(--toast-success-primary);
            --toast-bg: var(--toast-success-secondary);
            --toast-icon: "✓";
        }

        .toast.warning {
            --toast-primary: var(--toast-warning-primary);
            --toast-bg: var(--toast-warning-secondary);
            --toast-icon: "!";
        }

        .toast.error {
            --toast-primary: var(--toast-error-primary);
            --toast-bg: var(--toast-error-secondary);
            --toast-icon: "×";
        }

        /* Ajuste específico para el ícono de éxito */
        .toast.success::after {
            font-size: 1.4rem;
        }

        /* Animación de entrada suave */
        @keyframes toastSlideIn {
            from {
                transform: translateX(100%) rotateZ(5deg);
                opacity: 0;
            }

            to {
                transform: translateX(0) rotateZ(0deg);
                opacity: 1;
            }
        }

        .toast-item.show {
            animation: toastSlideIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Efecto hover en el toast */
        .toast:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }

        /* Barra de progreso para auto-close */
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0 0 20px 20px;
            transform-origin: left;
            transition: transform linear;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Contenedor de Toasts -->
    <div id="toast-container" class="toast-container"></div>

    <div class="flex">
        <!-- Sidebar Principal -->
        <div id="sidebar"
            class="sidebar-expanded bg-gradient-to-b from-slate-50 to-slate-100 border-r border-slate-200 min-h-screen transition-all duration-300 ease-in-out shadow-lg overflow-hidden">
            <!-- Header -->
            <div class="flex items-center p-4 border-b border-slate-200 bg-white/80 backdrop-blur-sm">
                <button id="logoToggle"
                    class="flex items-center space-x-3 hover:bg-slate-100/50 p-2 rounded-lg transition-all duration-200 w-full">
                    <div
                        class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md hover:shadow-lg transition-shadow flex-shrink-0">
                        <i class="fas fa-project-diagram text-white text-sm"></i>
                    </div>
                    <h1 class="nav-text text-xl font-semibold text-slate-700 sidebar-text">GraphUs</h1>
                </button>
            </div>

            <!-- Navigation Options -->
            <div class="p-3 space-y-2">
                <!-- Figuras -->
                <div class="nav-option-container">
                    <button
                        class="nav-option w-full flex items-center p-3 rounded-xl hover:bg-white/70 hover:shadow-sm transition-all duration-200 text-left group relative"
                        data-option="figuras" onclick="selectOption('figuras')">
                        <div
                            class="w-9 h-9 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0 shadow-sm group-hover:shadow-md transition-shadow">
                            <i class="fas fa-shapes text-white text-sm"></i>
                        </div>
                        <span class="nav-text text-sm font-medium text-slate-700 sidebar-text">Figuras</span>
                        <div class="tooltip sidebar-collapsed-only">Figuras</div>
                    </button>
                </div>

                <!-- Código -->
                <div class="nav-option-container">
                    <button
                        class="nav-option w-full flex items-center p-3 rounded-xl hover:bg-white/70 hover:shadow-sm transition-all duration-200 text-left group relative"
                        data-option="codigo" onclick="selectOption('codigo')">
                        <div
                            class="w-9 h-9 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0 shadow-sm group-hover:shadow-md transition-shadow">
                            <i class="fas fa-code text-white text-sm"></i>
                        </div>
                        <span class="nav-text text-sm font-medium text-slate-700 sidebar-text">Código</span>
                        <div class="tooltip sidebar-collapsed-only">Código</div>
                    </button>
                </div>

                <!-- Importar -->
                <div class="nav-option-container">
                    <button
                        class="nav-option w-full flex items-center p-3 rounded-xl hover:bg-white/70 hover:shadow-sm transition-all duration-200 text-left group relative"
                        data-option="importar" onclick="selectOption('importar')">
                        <div
                            class="w-9 h-9 bg-gradient-to-br from-violet-500 to-purple-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0 shadow-sm group-hover:shadow-md transition-shadow">
                            <i class="fas fa-download text-white text-sm"></i>
                        </div>
                        <span class="nav-text text-sm font-medium text-slate-700 sidebar-text">Importar</span>
                        <div class="tooltip sidebar-collapsed-only">Importar</div>
                    </button>
                </div>

                <!-- Exportar -->
                <div class="nav-option-container">
                    <button
                        class="nav-option w-full flex items-center p-3 rounded-xl hover:bg-white/70 hover:shadow-sm transition-all duration-200 text-left group relative"
                        data-option="exportar" onclick="selectOption('exportar')">
                        <div
                            class="w-9 h-9 bg-gradient-to-br from-orange-500 to-amber-600 rounded-lg flex items-center justify-center mr-3 flex-shrink-0 shadow-sm group-hover:shadow-md transition-shadow">
                            <i class="fas fa-upload text-white text-sm"></i>
                        </div>
                        <span class="nav-text text-sm font-medium text-slate-700 sidebar-text">Exportar</span>
                        <div class="tooltip sidebar-collapsed-only">Exportar</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Panel Lateral Derecho -->
        <div id="rightPanel"
            class="panel-collapsed bg-gradient-to-b from-white to-slate-50/50 border-r border-slate-200 min-h-screen transition-all duration-300 ease-in-out shadow-lg overflow-hidden">
            <div id="panelContent" class="p-6 h-full">
                <!-- Contenido dinámico se carga aquí -->
            </div>
        </div>

        <!-- Área Principal -->
        <div class="flex-1 bg-gray-50 relative overflow-hidden">
            <!-- Cuadrícula de fondo -->
            <div class="absolute inset-0 opacity-30">
                <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#cbd5e1" stroke-width="0.5" />
                        </pattern>
                        <pattern id="gridBold" width="100" height="100" patternUnits="userSpaceOnUse">
                            <path d="M 100 0 L 0 0 0 100" fill="none" stroke="#94a3b8" stroke-width="1" />
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" />
                    <rect width="100%" height="100%" fill="url(#gridBold)" />
                </svg>
            </div>

            <!-- Contenido centrado -->
            <div class="relative z-10 h-full flex items-center justify-center -mt-16">
                <div class="text-center">
                    <!-- Icono principal con animación sutil -->
                    <div class="mb-6 relative">
                        <div
                            class="w-24 h-24 mx-auto bg-gradient-to-br from-indigo-500/20 to-purple-600/20 rounded-2xl flex items-center justify-center backdrop-blur-sm border border-white/30 shadow-lg">
                            <i class="fas fa-project-diagram text-4xl text-indigo-600 animate-pulse"></i>
                        </div>
                        <!-- Círculos decorativos -->
                        <div class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full animate-bounce"
                            style="animation-delay: 0.5s;"></div>
                        <div class="absolute -bottom-2 -left-2 w-4 h-4 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full animate-bounce"
                            style="animation-delay: 1s;"></div>
                    </div>

                    <!-- Texto principal -->
                    <h2 class="text-2xl font-bold text-slate-800 mb-3">
                        Área de Trabajo
                    </h2>
                    <p class="text-lg text-slate-600 mb-6 max-w-md">
                        Selecciona una opción del navbar para comenzar a crear tu diagrama
                    </p>

                    <!-- Indicadores de funcionalidad -->
                    <div class="flex flex-wrap justify-center gap-4 max-w-lg mx-auto">
                        <div
                            class="flex items-center space-x-2 bg-white/80 backdrop-blur-sm px-4 py-2 rounded-full shadow-sm border border-white/50">
                            <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                            <span class="text-sm text-slate-700 font-medium">Arrastra y suelta</span>
                        </div>
                        <div
                            class="flex items-center space-x-2 bg-white/80 backdrop-blur-sm px-4 py-2 rounded-full shadow-sm border border-white/50">
                            <div class="w-3 h-3 bg-emerald-500 rounded-full animate-pulse"
                                style="animation-delay: 0.3s;"></div>
                            <span class="text-sm text-slate-700 font-medium">Cuadrícula inteligente</span>
                        </div>
                        <div
                            class="flex items-center space-x-2 bg-white/80 backdrop-blur-sm px-4 py-2 rounded-full shadow-sm border border-white/50">
                            <div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse"
                                style="animation-delay: 0.6s;"></div>
                            <span class="text-sm text-slate-700 font-medium">Conexiones automáticas</span>
                        </div>
                    </div>

                    <!-- Botón de acción sugerido -->
                    <div class="mt-8">
                        <button onclick="selectOption('figuras')"
                            class="inline-flex items-center space-x-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200">
                            <i class="fas fa-shapes"></i>
                            <span>Comenzar con Figuras</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Indicador de zoom en la esquina -->
            <div
                class="absolute bottom-6 right-6 bg-white/90 backdrop-blur-sm px-3 py-2 rounded-lg shadow-sm border border-white/50">
                <div class="flex items-center space-x-2 text-sm text-slate-600">
                    <i class="fas fa-search-plus text-xs"></i>
                    <span class="font-medium">100%</span>
                    <div class="w-px h-4 bg-slate-300"></div>
                    <button class="hover:text-slate-800 transition-colors" title="Ajustar al contenido">
                        <i class="fas fa-expand-arrows-alt text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        let currentOption = null;
        let isRightPanelOpen = false;
        let isSidebarCollapsed = false;
        let showingEntityOptions = false;
        let elementCounter = 0;

        // Contenido para cada opción
        const panelContent = {
            figuras: {
                title: 'Figuras de Diagrama',
                content: `
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Elementos de Entidad-Relación</h3>
                
                <div class="space-y-3">
                    <div id="tablaEntidad" class="p-3 border border-slate-200 rounded-xl hover:shadow-md hover:bg-white/80 transition-all duration-200 cursor-pointer group">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center shadow-sm group-hover:shadow-md transition-shadow">
                                <i class="fas fa-table text-white"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-800">Tabla/Entidad</div>
                                <div class="text-sm text-slate-500">Representa una entidad de base de datos</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="relacionElement" class="p-3 border border-slate-200 rounded-xl hover:shadow-md hover:bg-white/80 transition-all duration-200 cursor-pointer group">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-sm group-hover:shadow-md transition-shadow">
                                <i class="fas fa-link text-white"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-800">Relación</div>
                                <div class="text-sm text-slate-500">Conecta entidades entre sí</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="clavePrimariaElement" class="p-3 border border-slate-200 rounded-xl hover:shadow-md hover:bg-white/80 transition-all duration-200 cursor-pointer group">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-violet-500 to-purple-600 rounded-xl flex items-center justify-center shadow-sm group-hover:shadow-md transition-shadow">
                                <i class="fas fa-key text-white"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-800">Clave Primaria</div>
                                <div class="text-sm text-slate-500">Identificador único de la entidad</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="claveForaneaElement" class="p-3 border border-slate-200 rounded-xl hover:shadow-md hover:bg-white/80 transition-all duration-200 cursor-pointer group">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-600 rounded-xl flex items-center justify-center shadow-sm group-hover:shadow-md transition-shadow">
                                <i class="fas fa-external-link-alt text-white"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-slate-800">Clave Foránea</div>
                                <div class="text-sm text-slate-500">Referencia a otra entidad</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                    <p class="text-sm text-slate-700">
                        <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                        Haz clic en "Tabla/Entidad" para ver los tipos disponibles
                    </p>
                </div>
            </div>
        `,
                entityOptions: `
            <div class="space-y-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Tipos de Entidad</h3>
                    <button id="backToMain" class="text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors">
                        <i class="fas fa-arrow-left mr-1"></i>Volver
                    </button>
                </div>
                
                <div class="space-y-3">
                    <div class="entity-option p-3 border border-slate-200 rounded-xl hover:shadow-md hover:bg-blue-50 transition-all duration-200 cursor-pointer group" data-entity="entidad-simple">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg flex items-center justify-center shadow-sm">
                                    <div class="bg-white border border-gray-300 rounded text-xs p-1">
                                        <div class="bg-gray-100 px-2 py-1 text-center font-bold text-gray-700">Entity</div>
                                        <div class="border-t border-gray-300">
                                            <div class="px-1 py-0.5 text-gray-600">Field</div>
                                            <div class="px-1 py-0.5 text-gray-600">Field</div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-800">Entidad Simple</div>
                                    <div class="text-sm text-slate-500">Solo campos básicos</div>
                                </div>
                            </div>
                            <i class="fas fa-plus text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                    </div>
                    
                    <div class="entity-option p-3 border border-slate-200 rounded-xl hover:shadow-md hover:bg-green-50 transition-all duration-200 cursor-pointer group" data-entity="entidad-con-llaves">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-600 to-green-800 rounded-lg flex items-center justify-center shadow-sm">
                                    <div class="bg-white border border-gray-300 rounded text-xs p-1">
                                        <div class="bg-gray-100 px-2 py-1 text-center font-bold text-gray-700">Entity</div>
                                        <div class="border-t border-gray-300">
                                            <div class="px-1 py-0.5 text-gray-600 flex items-center">
                                                <i class="fas fa-key text-yellow-500 mr-1" style="font-size: 8px;"></i>Key
                                            </div>
                                            <div class="px-1 py-0.5 text-gray-600">Field</div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-800">Entidad con Llaves</div>
                                    <div class="text-sm text-slate-500">Incluye claves primarias</div>
                                </div>
                            </div>
                            <i class="fas fa-plus text-green-600 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                    </div>
                    
                    <div class="entity-option p-3 border border-slate-200 rounded-xl hover:shadow-md hover:bg-purple-50 transition-all duration-200 cursor-pointer group" data-entity="entidad-con-tipos">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-600 to-purple-800 rounded-lg flex items-center justify-center shadow-sm">
                                    <div class="bg-white border border-gray-300 rounded text-xs p-1">
                                        <div class="bg-gray-100 px-2 py-1 text-center font-bold text-gray-700">Entity</div>
                                        <div class="border-t border-gray-300">
                                            <div class="px-1 py-0.5 text-gray-600 flex justify-between">
                                                <span>Field</span><span class="text-blue-600">Type</span>
                                            </div>
                                            <div class="px-1 py-0.5 text-gray-600 flex justify-between">
                                                <span>Field</span><span class="text-blue-600">Type</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-800">Entidad con Tipos</div>
                                    <div class="text-sm text-slate-500">Campos con tipos de datos</div>
                                </div>
                            </div>
                            <i class="fas fa-plus text-purple-600 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                    </div>
                    
                    <div class="entity-option p-3 border border-slate-200 rounded-xl hover:shadow-md hover:bg-orange-50 transition-all duration-200 cursor-pointer group" data-entity="entidad-completa">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-600 to-orange-800 rounded-lg flex items-center justify-center shadow-sm">
                                    <div class="bg-white border border-gray-300 rounded text-xs p-1">
                                        <div class="bg-gray-100 px-2 py-1 text-center font-bold text-gray-700">Entity</div>
                                        <div class="border-t border-gray-300">
                                            <div class="px-1 py-0.5 text-gray-600 flex">
                                                <i class="fas fa-key text-yellow-500 mr-1" style="font-size: 8px;"></i>
                                                <span class="flex-1">Field</span>
                                                <span class="text-blue-600">Type</span>
                                            </div>
                                            <div class="px-1 py-0.5 text-gray-600 flex justify-between">
                                                <span>Field</span><span class="text-blue-600">Type</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="font-semibold text-slate-800">Entidad Completa</div>
                                    <div class="text-sm text-slate-500">Llaves, campos y tipos</div>
                                </div>
                            </div>
                            <i class="fas fa-plus text-orange-600 opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                    <p class="text-sm text-slate-700">
                        <i class="fas fa-mouse-pointer text-blue-500 mr-2"></i>
                        Haz clic en cualquier tipo para agregarlo al área de trabajo
                    </p>
                </div>
            </div>
        `
            },
            codigo: {
                title: 'Generador de Código SQL',
                content: `
    <div class="space-y-6">
        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 p-4 rounded-xl border border-emerald-200">
            <div class="flex items-center space-x-3 mb-3">
                <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center shadow-sm">
                    <i class="fas fa-database text-white"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-emerald-800">SQL Generator</h3>
                    <p class="text-sm text-emerald-600">Genera código SQL o crea diagramas desde SQL</p>
                </div>
            </div>
            
            <div class="flex space-x-2">
                <button onclick="toggleSQLFunction()" id="mainSQLButton" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200">
                    <i class="fas fa-magic mr-2"></i>
                    <span id="buttonText">Generar Diagrama</span>
                </button>
                <button onclick="copySQL()" class="px-4 py-2 border border-emerald-300 text-emerald-700 rounded-lg hover:bg-emerald-50 transition-colors duration-200" title="Copiar código">
                    <i class="fas fa-copy"></i>
                </button>
                <button onclick="downloadSQL()" class="px-4 py-2 border border-emerald-300 text-emerald-700 rounded-lg hover:bg-emerald-50 transition-colors duration-200" title="Descargar archivo">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
        
        <div class="space-y-3">
            <div class="flex items-center justify-between">
                <label class="text-sm font-semibold text-gray-700">Editor SQL</label>
                <div class="flex items-center space-x-2">
                    <button onclick="switchMode()" id="modeToggle" class="text-xs text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">
                        <i class="fas fa-exchange-alt mr-1"></i>
                        <span id="modeText">Modo: SQL → Diagrama</span>
                    </button>
                    <button onclick="expandSQLEditor()" class="text-xs text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">
                        <i id="expandIcon" class="fas fa-expand-alt mr-1"></i>
                        <span id="expandText">Expandir</span>
                    </button>
                    <button onclick="clearSQL()" class="text-xs text-gray-500 hover:text-gray-700 bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded transition-colors">
                        <i class="fas fa-eraser mr-1"></i>
                        Limpiar
                    </button>
                </div>
            </div>
            
            <div class="relative">
                <textarea id="sqlEditor" 
                    class="w-full h-64 p-4 border border-gray-300 rounded-xl text-sm font-mono bg-gray-50 focus:bg-white focus:border-emerald-400 focus:ring-2 focus:ring-emerald-100 transition-all duration-200 resize-none" 
                    placeholder="-- Pega tu código SQL aquí para generar un diagrama...
-- Ejemplo:
CREATE TABLE usuarios (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nombre VARCHAR(100) NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE pedidos (
    id INT PRIMARY KEY AUTO_INCREMENT,
    usuario_id INT NOT NULL,
    total DECIMAL(10,2),
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);"></textarea>
                <div class="absolute bottom-3 right-3 text-xs text-gray-400 bg-white px-2 py-1 rounded shadow-sm">
                    <i class="fas fa-code mr-1"></i>SQL
                </div>
            </div>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0 mt-0.5">
                    <i class="fas fa-lightbulb text-blue-600 text-sm"></i>
                </div>
                <div>
                    <h4 class="text-sm font-semibold text-blue-800 mb-2">Funcionalidades disponibles:</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• <strong>SQL → Diagrama:</strong> Pega código SQL y genera el diagrama automáticamente</li>
                        <li>• <strong>Diagrama → SQL:</strong> Genera código SQL desde las entidades del diagrama</li>
                        <li>• Detecta automáticamente claves primarias y foráneas</li>
                        <li>• Crea relaciones visuales entre tablas relacionadas</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
`
            },
            importar: {
                title: 'Importar Contenido',
                content: `
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Opciones de Importación</h3>
                
                <div class="space-y-3">
                    <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center hover:border-gray-400 transition-colors cursor-pointer">
                        <i class="fas fa-file-code text-2xl text-gray-400 mb-2"></i>
                        <div class="font-medium text-gray-700">Importar Código SQL</div>
                        <div class="text-sm text-gray-500">Arrastra tu archivo .sql aquí</div>
                    </div>
                    
                    <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center hover:border-gray-400 transition-colors cursor-pointer">
                        <i class="fas fa-file-alt text-2xl text-gray-400 mb-2"></i>
                        <div class="font-medium text-gray-700">Importar JSON Schema</div>
                        <div class="text-sm text-gray-500">Arrastra tu archivo .json aquí</div>
                    </div>
                    
                    <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg text-center hover:border-gray-400 transition-colors cursor-pointer">
                        <i class="fas fa-file-image text-2xl text-gray-400 mb-2"></i>
                        <div class="font-medium text-gray-700">Importar Diagrama</div>
                        <div class="text-sm text-gray-500">Formatos: .xml, .drawio</div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-upload text-blue-500 mr-2"></i>
                        También puedes importar desde URL o pegar código directamente
                    </p>
                </div>
            </div>
        `
            },
            exportar: {
                title: 'Exportar Proyecto',
                content: `
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Opciones de Exportación</h3>
                
                <div class="space-y-3">
                    <div class="p-3 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-blue-100 rounded flex items-center justify-center">
                                <i class="fas fa-image text-blue-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">Exportar como Imagen</div>
                                <div class="text-sm text-gray-500">PNG, JPG, SVG</div>
                            </div>
                        </div>
                    </div>
                    
<button onclick="exportSQLDiagramAsTXT()" 
    class="w-full p-3 border border-gray-200 rounded-lg hover:shadow-md transition-all flex items-center space-x-3 text-left">
    <div class="w-8 h-8 bg-green-100 rounded flex items-center justify-center">
        <i class="fas fa-file-code text-green-600 text-sm"></i>
    </div>
    <div>
        <div class="font-medium text-gray-800">Exportar Código SQL</div>
        <div class="text-sm text-gray-500">Script completo de la base de datos</div>
    </div>
</button>


                    
                    <div class="p-3 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow cursor-pointer">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-purple-100 rounded flex items-center justify-center">
                                <i class="fas fa-file-export text-purple-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">Exportar Proyecto</div>
                                <div class="text-sm text-gray-500">Archivo .graphus para compartir</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-3 border border-gray-200 rounded-lg hover:shadow-sm transition-shadow cursor-pointer">
                        <div  class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-yellow-100 rounded flex items-center justify-center">
                                <i class="fas fa-file-pdf text-yellow-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">Exportar Documentación</div>
                                <div class="text-sm text-gray-500">PDF con diagramas y código</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `
            }
        };

        // Definiciones de elementos ER con estilos mejorados
        const erElements = {
            'entidad-simple': {
                html: `<div class="bg-white border-2 border-gray-400 rounded-lg shadow-lg min-w-40 select-none">
                 <div class="bg-gray-100 border-b-2 border-gray-400 p-2 text-center font-bold text-gray-800 rounded-t-lg cursor-move">
                   <span contenteditable="true" class="entity-name">Entity</span>
                 </div>
                 <div class="p-2 space-y-1">
                   <div class="text-sm text-gray-700 py-1 px-2 border-b border-gray-200" contenteditable="true">Field1</div>
                   <div class="text-sm text-gray-700 py-1 px-2 border-b border-gray-200" contenteditable="true">Field2</div>
                   <div class="text-sm text-gray-700 py-1 px-2" contenteditable="true">Field3</div>
                 </div>
               </div>`,
                color: 'blue'
            },
            'entidad-con-llaves': {
                html: `<div class="bg-white border-2 border-gray-400 rounded-lg shadow-lg min-w-40 select-none">
                 <div class="bg-gray-100 border-b-2 border-gray-400 p-2 text-center font-bold text-gray-800 rounded-t-lg cursor-move">
                   <span contenteditable="true" class="entity-name">Entity</span>
                 </div>
                 <div class="p-2 space-y-1">
                   <div class="text-sm text-gray-700 py-1 px-2 border-b border-gray-200 flex items-center">
                     <i class="fas fa-key text-yellow-500 mr-2 text-xs"></i>
                     <span contenteditable="true">KeyField1</span>
                   </div>
                   <div class="text-sm text-gray-700 py-1 px-2 border-b border-gray-200 flex items-center">
                     <i class="fas fa-key text-yellow-500 mr-2 text-xs"></i>
                     <span contenteditable="true">KeyField2</span>
                   </div>
                   <div class="text-sm text-gray-700 py-1 px-2" contenteditable="true">Field</div>
                 </div>
               </div>`,
                color: 'green'
            },
            'entidad-con-tipos': {
                html: `<div class="bg-white border-2 border-gray-400 rounded-lg shadow-lg min-w-48 select-none">
                 <div class="bg-gray-100 border-b-2 border-gray-400 p-2 text-center font-bold text-gray-800 rounded-t-lg cursor-move">
                   <span contenteditable="true" class="entity-name">Entity</span>
                 </div>
                 <div class="p-2 space-y-1">
                   <div class="text-sm py-1 px-2 border-b border-gray-200 flex justify-between">
                     <span class="text-gray-700" contenteditable="true">Field1</span>
                     <span class="text-blue-600 font-medium text-xs" contenteditable="true">VARCHAR</span>
                   </div>
                   <div class="text-sm py-1 px-2 border-b border-gray-200 flex justify-between">
                     <span class="text-gray-700" contenteditable="true">Field2</span>
                     <span class="text-blue-600 font-medium text-xs" contenteditable="true">INT</span>
                   </div>
                   <div class="text-sm py-1 px-2 flex justify-between">
                     <span class="text-gray-700" contenteditable="true">Field3</span>
                     <span class="text-blue-600 font-medium text-xs" contenteditable="true">TEXT</span>
                   </div>
                 </div>
               </div>`,
                color: 'purple'
            },
            'entidad-completa': {
                html: `<div class="bg-white border-2 border-gray-400 rounded-lg shadow-lg min-w-52 select-none">
                 <div class="bg-gray-100 border-b-2 border-gray-400 p-2 text-center font-bold text-gray-800 rounded-t-lg cursor-move">
                   <span contenteditable="true" class="entity-name">Entity</span>
                 </div>
                 <div class="p-2 space-y-1">
                   <div class="text-sm py-1 px-2 border-b border-gray-200 flex justify-between items-center">
                     <div class="flex items-center">
                       <i class="fas fa-key text-yellow-500 mr-2 text-xs"></i>
                       <span class="text-gray-700" contenteditable="true">ID</span>
                     </div>
                     <span class="text-blue-600 font-medium text-xs" contenteditable="true">INT</span>
                   </div>
                   <div class="text-sm py-1 px-2 border-b border-gray-200 flex justify-between items-center">
                     <div class="flex items-center">
                       <i class="fas fa-key text-yellow-500 mr-2 text-xs"></i>
                       <span class="text-gray-700" contenteditable="true">Code</span>
                     </div>
                     <span class="text-blue-600 font-medium text-xs" contenteditable="true">VARCHAR</span>
                   </div>
                   <div class="text-sm py-1 px-2 flex justify-between">
                     <span class="text-gray-700" contenteditable="true">Name</span>
                     <span class="text-blue-600 font-medium text-xs" contenteditable="true">VARCHAR</span>
                   </div>
                 </div>
               </div>`,
                color: 'orange'
            }
        };

        // ===== FUNCIONES PRINCIPALES =====

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarTexts = document.querySelectorAll('.sidebar-text');
            const tooltips = document.querySelectorAll('.tooltip');

            isSidebarCollapsed = !isSidebarCollapsed;

            if (isSidebarCollapsed) {
                sidebarTexts.forEach(text => {
                    text.style.display = 'none';
                });

                setTimeout(() => {
                    sidebar.classList.remove('sidebar-expanded');
                    sidebar.classList.add('sidebar-collapsed');
                }, 50);

                setTimeout(() => {
                    tooltips.forEach(tooltip => {
                        tooltip.style.display = 'block';
                    });
                }, 400);

                if (isRightPanelOpen) {
                    closeRightPanel();
                }
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');

                tooltips.forEach(tooltip => {
                    tooltip.style.display = 'none';
                });

                setTimeout(() => {
                    sidebarTexts.forEach(text => {
                        text.style.display = 'block';
                    });
                }, 300);
            }
        }

        function selectOption(option) {
            if (isSidebarCollapsed) {
                toggleSidebar();
                setTimeout(() => {
                    selectOptionInternal(option);
                }, 400);
            } else {
                selectOptionInternal(option);
            }
        }

        function selectOptionInternal(option) {
            document.querySelectorAll('.nav-option').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-md', 'border-l-4', 'border-indigo-500');
            });

            const currentBtn = document.querySelector(`[data-option="${option}"]`);
            if (currentBtn) {
                currentBtn.classList.add('bg-white', 'shadow-md', 'border-l-4', 'border-indigo-500');
            }

            if (currentOption === option && isRightPanelOpen && !showingEntityOptions) {
                closeRightPanel();
            } else {
                openRightPanel(option);
            }

            currentOption = option;
            showingEntityOptions = false;
        }

        function openRightPanel(option) {
            const panel = document.getElementById('rightPanel');
            const content = document.getElementById('panelContent');

            panel.classList.remove('panel-collapsed');
            panel.classList.add('panel-expanded');

            if (option === 'figuras') {
                content.innerHTML = `
            <div class="slide-in">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-200">
                    <h2 class="text-xl font-semibold text-slate-800">${panelContent[option].title}</h2>
                    <button onclick="closeRightPanel()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                        <i class="fas fa-times text-slate-500 hover:text-slate-700"></i>
                    </button>
                </div>
                ${panelContent[option].content}
            </div>
        `;

                setTimeout(() => {
                    const tablaEntidad = document.getElementById('tablaEntidad');
                    if (tablaEntidad) {
                        tablaEntidad.addEventListener('click', showEntityOptions);
                    }

                    // Agregar event listeners a otros elementos ER
                    const relacionElement = document.getElementById('relacionElement');
                    const clavePrimariaElement = document.getElementById('clavePrimariaElement');
                    const claveForaneaElement = document.getElementById('claveForaneaElement');

                    if (relacionElement) {
                        relacionElement.addEventListener('click', () => {
                            showNotification('Funcionalidad de relaciones próximamente', 'info');
                        });
                    }

                    if (clavePrimariaElement) {
                        clavePrimariaElement.addEventListener('click', () => {
                            showNotification('Funcionalidad de claves primarias próximamente', 'info');
                        });
                    }

                    if (claveForaneaElement) {
                        claveForaneaElement.addEventListener('click', () => {
                            showNotification('Funcionalidad de claves foráneas próximamente', 'info');
                        });
                    }
                }, 100);
            } else {
                content.innerHTML = `
            <div class="slide-in">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-200">
                    <h2 class="text-xl font-semibold text-slate-800">${panelContent[option].title}</h2>
                    <button onclick="closeRightPanel()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                        <i class="fas fa-times text-slate-500 hover:text-slate-700"></i>
                    </button>
                </div>
                ${panelContent[option].content}
            </div>
        `;
            }

            isRightPanelOpen = true;
        }

        function showEntityOptions() {
            const content = document.getElementById('panelContent');

            content.innerHTML = `
        <div class="slide-in">
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-slate-200">
                <h2 class="text-xl font-semibold text-slate-800">Tipos de Entidad</h2>
                <button onclick="closeRightPanel()" class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
                    <i class="fas fa-times text-slate-500 hover:text-slate-700"></i>
                </button>
            </div>
            ${panelContent.figuras.entityOptions}
            <br>
<div class="entity-option p-3 border border-slate-200 rounded-xl hover:shadow-md hover:bg-red-50 transition-all duration-200 cursor-pointer group" 
     data-type="connection" data-entity="conexion-uno-muchos">
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-gradient-to-br from-red-600 to-red-800 rounded-lg flex items-center justify-center shadow-sm">
                <i class="fas fa-project-diagram text-white"></i>
            </div>
            <div>
                <div class="font-semibold text-slate-800">Conexión 1:N</div>
                <div class="text-sm text-slate-500">Relaciona entidades</div>
            </div>
        </div>
        <i class="fas fa-plus text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"></i>
    </div>
</div>


        </div>
    `;

            showingEntityOptions = true;

            setTimeout(() => {
                const backButton = document.getElementById('backToMain');
                if (backButton) {
                    backButton.addEventListener('click', () => {
                        openRightPanel('figuras');
                        showingEntityOptions = false;
                    });
                }

                document.querySelectorAll('.entity-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const entityType = e.currentTarget.dataset.entity;
                        addEntityToWorkspace(entityType);
                        showNotification('Entidad agregada al área de trabajo', 'success');
                    });
                });
            }, 100);
        }

        function addEntityToWorkspace(entityType) {
            const workspace = document.getElementById('workspaceArea');
            const welcomeMessage = document.getElementById('welcomeMessage');

            if (!workspace) {
                console.error('No se encontró el área de trabajo');
                return;
            }

            if (welcomeMessage && welcomeMessage.style.display !== 'none') {
                welcomeMessage.style.display = 'none';
            }

            const element = document.createElement('div');
            element.className = 'er-element absolute transition-all duration-200 hover:shadow-xl';
            element.innerHTML = erElements[entityType].html;

            const maxX = Math.max(workspace.offsetWidth - 250, 100);
            const maxY = Math.max(workspace.offsetHeight - 200, 100);
            const x = Math.random() * maxX + 50;
            const y = Math.random() * maxY + 50;

            element.style.left = x + 'px';
            element.style.top = y + 'px';
            element.id = `element-${entityType}-${++elementCounter}`;

            // Agregar contexto de menú (clic derecho)
            element.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, element);
            });

            // Hacer doble clic para editar
            element.addEventListener('dblclick', (e) => {
                e.preventDefault();
                editEntityProperties(element);
            });

            makeDraggable(element);
            workspace.appendChild(element);

            // Efecto de entrada
            element.style.transform = 'scale(0.8)';
            element.style.opacity = '0';

            setTimeout(() => {
                element.style.transform = 'scale(1.05)';
                element.style.opacity = '1';
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 200);
            }, 50);
        }

        function makeDraggable(element) {
            let isDragging = false;
            let currentX = 0;
            let currentY = 0;
            let initialX = 0;
            let initialY = 0;
            let xOffset = 0;
            let yOffset = 0;

            const dragHandle = element.querySelector('.cursor-move') || element;

            dragHandle.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                // No permitir drag si se está editando texto
                if (e.target.contentEditable === 'true') {
                    return;
                }

                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === dragHandle || dragHandle.contains(e.target)) {
                    isDragging = true;
                    element.classList.add('dragging', 'z-50');
                    element.style.cursor = 'grabbing';
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    // Limitar el drag dentro del workspace
                    const workspace = document.getElementById('workspaceArea');
                    if (workspace) {
                        const rect = workspace.getBoundingClientRect();
                        const maxX = workspace.offsetWidth - element.offsetWidth;
                        const maxY = workspace.offsetHeight - element.offsetHeight;

                        currentX = Math.max(0, Math.min(currentX, maxX));
                        currentY = Math.max(0, Math.min(currentY, maxY));
                    }

                    setTranslate(currentX, currentY, element);
                }
            }

            function dragEnd(e) {
                if (isDragging) {
                    initialX = currentX;
                    initialY = currentY;

                    isDragging = false;
                    element.classList.remove('dragging', 'z-50');
                    element.style.cursor = 'default';
                }
            }

            function setTranslate(xPos, yPos, el) {
                el.style.left = xPos + 'px';
                el.style.top = yPos + 'px';
            }
        }

        function closeRightPanel() {
            const panel = document.getElementById('rightPanel');
            panel.classList.remove('panel-expanded');
            panel.classList.add('panel-collapsed');

            document.querySelectorAll('.nav-option').forEach(btn => {
                btn.classList.remove('bg-white', 'shadow-md', 'border-l-4', 'border-indigo-500');
            });

            isRightPanelOpen = false;
            currentOption = null;
            showingEntityOptions = false;
        }

        // ===== FUNCIONES AUXILIARES =====

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;

            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };

            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            notification.className += ' ' + colors[type];
            notification.innerHTML = `
        <div class="flex items-center space-x-2">
            <i class="${icons[type]}"></i>
            <span>${message}</span>
        </div>
    `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function showContextMenu(e, element) {
            // Remover menús existentes
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            const menu = document.createElement('div');
            menu.className = 'context-menu fixed bg-white shadow-lg border rounded-lg py-2 z-50';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';

            menu.innerHTML = `
        <button class="context-option w-full px-4 py-2 text-left hover:bg-gray-100 text-sm" data-action="edit">
            <i class="fas fa-edit mr-2"></i>Editar
        </button>
        <button class="context-option w-full px-4 py-2 text-left hover:bg-gray-100 text-sm" data-action="duplicate">
            <i class="fas fa-copy mr-2"></i>Duplicar
        </button>
        <div class="border-t my-1"></div>
        <button class="context-option w-full px-4 py-2 text-left hover:bg-red-50 text-red-600 text-sm" data-action="delete">
            <i class="fas fa-trash mr-2"></i>Eliminar
        </button>
    `;

            document.body.appendChild(menu);

            // Event listeners para las opciones del menú
            menu.querySelectorAll('.context-option').forEach(option => {
                option.addEventListener('click', () => {
                    const action = option.dataset.action;
                    handleContextAction(action, element);
                    menu.remove();
                });
            });

            // Cerrar menú al hacer clic fuera
            setTimeout(() => {
                document.addEventListener('click', () => {
                    menu.remove();
                }, { once: true });
            }, 100);
        }

        function handleContextAction(action, element) {
            switch (action) {
                case 'edit':
                    editEntityProperties(element);
                    break;
                case 'duplicate':
                    duplicateEntity(element);
                    break;
                case 'delete':
                    deleteEntity(element);
                    break;
            }
        }

        function editEntityProperties(element) {
            // Implementar editor de propiedades
            showNotification('Editor de propiedades próximamente', 'info');
        }

        function duplicateEntity(element) {
            const clone = element.cloneNode(true);
            clone.id = `element-duplicate-${++elementCounter}`;

            // Desplazar la posición
            const currentLeft = parseInt(element.style.left);
            const currentTop = parseInt(element.style.top);
            clone.style.left = (currentLeft + 20) + 'px';
            clone.style.top = (currentTop + 20) + 'px';

            makeDraggable(clone);

            // Agregar event listeners
            clone.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showContextMenu(e, clone);
            });

            clone.addEventListener('dblclick', (e) => {
                e.preventDefault();
                editEntityProperties(clone);
            });

            element.parentNode.appendChild(clone);
            showNotification('Entidad duplicada', 'success');
        }

        function deleteEntity(element) {
            if (confirm('¿Estás seguro de que quieres eliminar esta entidad?')) {
                element.style.transform = 'scale(0)';
                element.style.opacity = '0';

                setTimeout(() => {
                    element.remove();
                    showNotification('Entidad eliminada', 'success');
                }, 300);
            }
        }

        // ===== FUNCIONES SQL =====

        let isExpanded = false;
        let originalHeight = '16rem';

        // ===== FUNCIÓN MEJORADA PARA GENERAR SQL =====
        // ===== FUNCIÓN CORREGIDA PARA GENERAR SQL CON FOREIGN KEYS =====
        function generateSQL() {
            const sqlEditor = document.getElementById('sqlEditor');

            // Código para generar SQL desde entidades
            const workspace = document.getElementById('workspaceArea');
            const entities = workspace.querySelectorAll('.er-element');

            if (entities.length === 0) {
                showNotification('No hay entidades para generar SQL', 'warning');
                return;
            }

            // Array para construir el SQL línea por línea
            const sqlLines = [];

            sqlLines.push('-- Script SQL generado automáticamente');
            sqlLines.push('-- Fecha: ' + new Date().toLocaleString());
            sqlLines.push('');

            // Primero generar todas las tablas sin foreign keys
            entities.forEach((entity) => {
                const entityName = entity.querySelector('th')?.textContent?.trim() || 'tabla';
                const rows = entity.querySelectorAll('tbody tr');

                sqlLines.push(`CREATE TABLE ${entityName.toLowerCase()} (`);

                const fieldLines = [];
                const primaryKeys = [];

                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 2) {
                        const keyCell = cells[0];
                        const nameCell = cells[1];
                        const typeCell = cells[2]; // La tercera columna con el tipo

                        const fieldName = nameCell.textContent.trim();
                        const hasPrimaryKey = keyCell.querySelector('.fa-key');
                        const hasForeignKey = keyCell.querySelector('.fa-external-link-alt');

                        // Obtener el tipo de dato
                        let dataType = 'VARCHAR(255)'; // Valor por defecto
                        if (typeCell && typeCell.textContent.trim()) {
                            dataType = typeCell.textContent.trim();

                            // Asegurar que los tipos de datos sean válidos en MySQL
                            if (dataType.toUpperCase().includes('INTEGER')) {
                                dataType = dataType.replace(/INTEGER/i, 'INT');
                            }
                            if (dataType.toUpperCase().includes('NUMBER')) {
                                dataType = dataType.replace(/NUMBER/i, 'INT');
                            }
                            if (dataType.toUpperCase().includes('STRING')) {
                                dataType = dataType.replace(/STRING/i, 'VARCHAR(255)');
                            }
                            if (dataType.toUpperCase().includes('TEXT') && !dataType.includes('(')) {
                                dataType = 'TEXT';
                            }
                            if (dataType.toUpperCase().includes('DATE') && !dataType.toUpperCase().includes('TIME')) {
                                dataType = 'DATE';
                            }
                            if (dataType.toUpperCase().includes('DECIMAL') && !dataType.includes('(')) {
                                dataType = 'DECIMAL(10,2)';
                            }
                        }

                        // Solo agregar el campo (las FKs se agregarán después como constraints)
                        let line = `    ${fieldName.toLowerCase()} ${dataType}`;

                        if (hasPrimaryKey) {
                            line += ' PRIMARY KEY';
                            primaryKeys.push(fieldName.toLowerCase());
                            if (dataType.toUpperCase().includes('INT')) {
                                line += ' AUTO_INCREMENT';
                            }
                        }

                        // Agregar NOT NULL a campos importantes
                        if (!hasPrimaryKey) {
                            if (fieldName.toLowerCase().includes('nombre') ||
                                fieldName.toLowerCase().includes('email') ||
                                fieldName.toLowerCase().includes('titulo') ||
                                fieldName.toLowerCase().includes('fecha') ||
                                fieldName.toLowerCase().includes('monto')) {
                                line += ' NOT NULL';
                            }
                        }

                        fieldLines.push(line);
                    }
                });

                // Unir campos con comas
                for (let i = 0; i < fieldLines.length; i++) {
                    if (i < fieldLines.length - 1) {
                        sqlLines.push(fieldLines[i] + ',');
                    } else {
                        sqlLines.push(fieldLines[i]);
                    }
                }

                sqlLines.push(');');
                sqlLines.push('');
            });

            // Ahora agregar las foreign keys como ALTER TABLE statements
            if (window.allConnections && allConnections.length > 0) {
                sqlLines.push('-- Agregar relaciones (Foreign Keys)');
                sqlLines.push('');

                // Usar un objeto para evitar constraints duplicados
                const addedConstraints = {};

                allConnections.forEach((conn, index) => {
                    const table1Name = conn.table1?.querySelector('th')?.textContent?.trim().toLowerCase() || 'table1';
                    const tableNName = conn.tableN?.querySelector('th')?.textContent?.trim().toLowerCase() || 'tableN';

                    // Buscar campo que podría ser foreign key en la tabla N
                    const foreignKeyField = findForeignKeyField(conn.tableN, table1Name);
                    const primaryKeyField = findPrimaryKeyField(conn.table1);

                    if (foreignKeyField && primaryKeyField) {
                        const constraintName = `fk_${tableNName}_${table1Name}`;

                        // Evitar agregar la misma constraint múltiples veces
                        if (!addedConstraints[constraintName]) {
                            sqlLines.push(`ALTER TABLE ${tableNName}`);
                            sqlLines.push(`ADD CONSTRAINT ${constraintName}`);
                            sqlLines.push(`FOREIGN KEY (${foreignKeyField}) REFERENCES ${table1Name}(${primaryKeyField});`);
                            sqlLines.push('');

                            addedConstraints[constraintName] = true;
                        }
                    }
                });
            }

            // Unir todas las líneas con saltos de línea reales
            const finalSQL = sqlLines.join('\n');
            sqlEditor.value = finalSQL;
            showNotification('Código SQL generado exitosamente', 'success');
        }

        // Función auxiliar mejorada para encontrar campo de foreign key
        function findForeignKeyField(entity, referencedTableName) {
            if (!entity) return null;

            const rows = entity.querySelectorAll('tbody tr');
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    const keyCell = cells[0];
                    const nameCell = cells[1];
                    const fieldName = nameCell.textContent.trim().toLowerCase();

                    // Buscar campos con icono FK o que contengan el nombre de la tabla referenciada
                    if (keyCell.querySelector('.fa-external-link-alt') ||
                        fieldName.includes(referencedTableName.toLowerCase()) ||
                        fieldName.includes('id' + referencedTableName.toLowerCase()) ||
                        fieldName === referencedTableName.toLowerCase() + 'id' ||
                        fieldName === 'id_' + referencedTableName.toLowerCase()) {
                        return fieldName;
                    }
                }
            }
            return null;
        }

        // Función auxiliar mejorada para encontrar campo de primary key
        function findPrimaryKeyField(entity) {
            if (!entity) return 'id';

            const rows = entity.querySelectorAll('tbody tr');
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    const keyCell = cells[0];
                    const nameCell = cells[1];

                    if (keyCell.querySelector('.fa-key')) {
                        return nameCell.textContent.trim().toLowerCase();
                    }
                }
            }
            return 'id'; // Por defecto
        }

        function expandSQLEditor() {
            const sqlEditor = document.getElementById('sqlEditor');
            const expandIcon = document.getElementById('expandIcon');
            const expandText = document.getElementById('expandText');

            const currentHeight = sqlEditor.style.height || '256px';

            if (currentHeight === '256px' || !sqlEditor.style.height) {
                sqlEditor.style.height = '400px';
                expandIcon.className = 'fas fa-compress-alt mr-1';
                expandText.textContent = 'Contraer';
                showNotification('Editor expandido', 'info');
            } else {
                sqlEditor.style.height = '256px';
                expandIcon.className = 'fas fa-expand-alt mr-1';
                expandText.textContent = 'Expandir';
                showNotification('Editor contraído', 'info');
            }
        }


        function clearSQL() {
            const sqlEditor = document.getElementById('sqlEditor');
            sqlEditor.value = '';
            showNotification('Editor SQL limpiado', 'info');
        }

        function copySQL() {
            const sqlEditor = document.getElementById('sqlEditor');
            if (sqlEditor.value.trim()) {
                navigator.clipboard.writeText(sqlEditor.value)
                    .then(() => showNotification('Código SQL copiado al portapapeles', 'success'))
                    .catch(() => {
                        // Fallback para navegadores que no soportan clipboard API
                        sqlEditor.select();
                        document.execCommand('copy');
                        showNotification('Código SQL copiado', 'success');
                    });
            } else {
                showNotification('No hay código SQL para copiar', 'warning');
            }
        }

        function downloadSQL() {
            const sqlEditor = document.getElementById('sqlEditor');
            const content = sqlEditor.value.trim();

            if (!content) {
                showNotification('No hay código SQL para descargar', 'warning');
                return;
            }

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');

            const fileName = `database_schema_${new Date().toISOString().slice(0, 10)}.sql`;
            a.href = url;
            a.download = fileName;
            a.click();

            window.URL.revokeObjectURL(url);
            showNotification(`Archivo descargado: ${fileName}`, 'success');
        }

        // ===== EVENT LISTENERS =====

        document.addEventListener('DOMContentLoaded', function () {
            const logoToggle = document.getElementById('logoToggle');
            if (logoToggle) {
                logoToggle.addEventListener('click', toggleSidebar);
            }

            // Inicializar tooltips como ocultos
            document.querySelectorAll('.tooltip').forEach(tooltip => {
                tooltip.style.display = 'none';
            });

            // Prevenir selección de texto en elementos draggables
            document.addEventListener('selectstart', function (e) {
                if (e.target.closest('.er-element')) {
                    e.preventDefault();
                }
            });

            // Cerrar menú contextual con Escape
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    const contextMenu = document.querySelector('.context-menu');
                    if (contextMenu) {
                        contextMenu.remove();
                    }
                }
            });
        });

        // Exportar funciones para uso global
        window.toggleSidebar = toggleSidebar;
        window.selectOption = selectOption;
        window.closeRightPanel = closeRightPanel;
        window.expandSQLEditor = expandSQLEditor;
        window.clearSQL = clearSQL;
        window.copySQL = copySQL;
        window.downloadSQL = downloadSQL;
        window.generateSQL = generateSQL;


        // ===== PARSER DE SQL A DIAGRAMA =====

        /**
         * Parsea código SQL y genera el diagrama correspondiente
         */
        function parseQLToiagram() {
            const sqlEditor = document.getElementById('sqlEditor');
            const sqlCode = sqlEditor.value.trim();

            if (!sqlCode) {
                showNotification('Por favor ingresa código SQL para parsear', 'warning');
                return;
            }

            try {
                showNotification('Generando diagrama desde SQL...', 'info');

                // Limpiar workspace antes de generar
                const workspace = createWorkspaceArea();
                clearWorkspace();

                const tables = parseSQLTables(sqlCode);
                const relationships = parseSQLRelationships(sqlCode, tables);

                if (tables.length === 0) {
                    showNotification('No se encontraron tablas válidas en el código SQL', 'warning');
                    return;
                }

                // Crear entidades en el workspace
                createEntitiesFromTables(tables, workspace);

                // Crear relaciones después de un pequeño delay para que las entidades se rendericen
                setTimeout(() => {
                    createRelationshipsFromSQL(relationships, workspace);
                    showNotification(`Diagrama generado: ${tables.length} tablas, ${relationships.length} relaciones`, 'success');
                }, 500);

            } catch (error) {
                console.error('Error parseando SQL:', error);
                showNotification('Error al parsear el código SQL: ' + error.message, 'error');
            }
        }

        // ===== FUNCIÓN AUXILIAR MEJORADA PARA EXTRAER TABLAS =====
        function extractCreateTableBlocks(sql) {
            const blocks = [];
            const re = /CREATE\s+TABLE\s+(?:IF\s+NOT\s+EXISTS\s+)?`?([A-Za-z_][A-Za-z0-9_]*)`?\s*\(/gi;

            let m;
            while ((m = re.exec(sql)) !== null) {
                const tableName = m[1];
                const openIndex = re.lastIndex - 1;

                let pos = openIndex + 1;
                let depth = 1;
                let inSingle = false, inDouble = false, inBacktick = false;
                let inLineComment = false, inBlockComment = false;

                while (pos < sql.length && depth > 0) {
                    const ch = sql[pos];
                    const next = sql[pos + 1];

                    if (inLineComment) {
                        if (ch === '\n') inLineComment = false;
                        pos++; continue;
                    }
                    if (inBlockComment) {
                        if (ch === '*' && next === '/') { inBlockComment = false; pos += 2; continue; }
                        pos++; continue;
                    }

                    if (!inSingle && !inDouble && !inBacktick) {
                        if (ch === '-' && next === '-') { inLineComment = true; pos += 2; continue; }
                        if (ch === '/' && next === '*') { inBlockComment = true; pos += 2; continue; }
                        if (ch === "'") { inSingle = true; pos++; continue; }
                        if (ch === '"') { inDouble = true; pos++; continue; }
                        if (ch === '`') { inBacktick = true; pos++; continue; }

                        if (ch === '(') { depth++; pos++; continue; }
                        if (ch === ')') {
                            depth--; pos++;
                            if (depth === 0) break;
                            continue;
                        }
                        pos++; continue;
                    } else {
                        // dentro de comillas
                        if (inSingle && ch === "'" && sql[pos - 1] !== '\\') inSingle = false;
                        else if (inDouble && ch === '"' && sql[pos - 1] !== '\\') inDouble = false;
                        else if (inBacktick && ch === '`') inBacktick = false;
                        pos++; continue;
                    }
                }

                const body = sql.slice(openIndex + 1, pos).trim();
                // saltar al ; que cierra el CREATE TABLE (si existe)
                const semi = sql.indexOf(';', pos);
                re.lastIndex = semi === -1 ? pos : semi + 1;

                blocks.push({ name: tableName, body });
            }
            return blocks;
        }


        // --- B. PARSEAR TABLAS Y CAMPOS USANDO EL EXTRACTOR ---
        function parseCreateTables(sql) {
            const tables = [];
            const relationships = [];

            const blocks = extractCreateTableBlocks(sql);
            for (const blk of blocks) {
                const tableName = blk.name;
                const tableBody = blk.body;

                console.log("=== TABLA ENCONTRADA ===");
                console.log("Nombre:", tableName);
                console.log("Contenido RAW:", JSON.stringify(tableBody.substring(0, 200)));

                const fields = [];
                const lines = smartSplitByComma(tableBody); // ya la tenés

                console.log("--- PARSEANDO CAMPOS ---");
                console.log("Contenido:", tableBody);
                console.log("Líneas divididas:", lines);

                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();

                    // ⚡ Fix: limpiar si la línea termina con ")" extra
                    if (line.endsWith(")")) {
                        line = line.slice(0, -1).trim();
                    }

                    if (!line || line.length < 2) continue;

                    console.log(`Procesando línea ${i}: "${line}"`);

                    // Ignorar constraints de tabla (PRIMARY KEY(...), UNIQUE(...), etc.)
                    if (shouldIgnoreLine(line)) {
                        console.log("  → Línea ignorada (constraint)");
                        // Pero si aquí viene un FOREIGN KEY inline, lo capturamos:
                        const fkInline = line.match(/FOREIGN\s+KEY\s*\((`?\w+`?)\)\s+REFERENCES\s+`?(\w+)`?\s*\((`?\w+`?)\)/i);
                        if (fkInline) {
                            const fromField = fkInline[1].replace(/`/g, "");
                            const toTable = fkInline[2];
                            const toField = fkInline[3].replace(/`/g, "");
                            relationships.push({ fromTable: tableName, toTable, fromField, toField, type: "N:1" });
                            console.log(`  ✓ Relación detectada (inline): ${tableName}.${fromField} → ${toTable}.${toField}`);
                        }
                        continue;
                    }

                    // Campo normal
                    const field = parseFieldLine(line); // tu función existente
                    if (field) {
                        fields.push(field);
                        console.log(`  ✓ Campo agregado: ${field.name} (${field.type})`);
                    } else {
                        console.log(`  ✗ No se pudo parsear: "${line}"`);
                    }
                }

                tables.push({ name: tableName, fields });
                console.log("Campos parseados:", fields);
                console.log(`✓ Tabla ${tableName} agregada con ${fields.length} campos`);
            }

            console.log("=== RESULTADO FINAL (parser) ===");
            console.log("Total tablas:", tables.length);
            console.log("Total relaciones encontradas (inline):", relationships.length);

            return { tables, relationships };
        }

        // --- C. ALIAS DE COMPATIBILIDAD PARA NO ROMPER LO DEMÁS ---
        // Si otras partes siguen llamando parseSQLTables(sql), esto lo resuelve.
        function parseSQLTables(sql) {
            const { tables } = parseCreateTables(sql);
            return tables;
        }

        function parseTableFields(tableBody) {
            return parseTableFieldsFixed(tableBody);
        }

        /**
         * Parsea los campos de una tabla y detecta FOREIGN KEY inline de forma tolerante.
         * Devuelve { fields, inlineRelations }
         */
        function parseTableFieldsFixed(tableName, rawContent) {
            const fields = [];
            const inlineRelations = [];

            // Usa tu smartSplitByComma actual
            const lines = smartSplitByComma(rawContent);

            // Regex tolerante para FOREIGN KEY inline:
            // - Permite backticks opcionales
            // - No exige el paréntesis final de la columna referenciada
            // - Tolera un ')' extra al final (pegado al cierre de la tabla)
            const FK_INLINE_REGEX =
                /FOREIGN\s+KEY\s*\(\s*`?([a-zA-Z0-9_]+)`?\s*\)\s+REFERENCES\s+`?([a-zA-Z0-9_]+)`?\s*\(\s*`?([a-zA-Z0-9_]+)`?\s*\)?/i;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();

                // 0) Intentar primero capturar FOREIGN KEY (ANTES de ignorar la línea)
                const fkMatch = line.match(FK_INLINE_REGEX);
                if (fkMatch) {
                    const fromField = fkMatch[1];
                    const toTable = fkMatch[2];
                    const toField = fkMatch[3];

                    // Marcar el campo si ya existe; si no, crearlo
                    let f = fields.find(x => x.name?.toLowerCase() === fromField.toLowerCase());
                    if (!f) {
                        f = {
                            name: fromField,
                            type: 'INT',               // default razonable
                            isPrimary: false,
                            isAuto: false,
                            isForeign: true,
                            referencesTable: toTable,
                            referencesField: toField
                        };
                        fields.push(f);
                    } else {
                        f.isForeign = true;
                        f.referencesTable = toTable;
                        f.referencesField = toField;
                    }

                    // Guardar relación inline
                    inlineRelations.push({
                        fromTable: tableName,
                        toTable,
                        fromField,
                        toField,
                        type: 'N:1'
                    });

                    console.log(`  ✓ Relación detectada (inline): ${tableName}.${fromField} → ${toTable}.${toField}`);
                    continue; // ya procesada esta línea
                }

                // 1) Si no es FK, podemos decidir si ignorarla (constraints, comments, etc.)
                if (shouldIgnoreLine(line)) {
                    console.log("  → Línea ignorada (constraint/comentario)");
                    continue;
                }

                // 2) Parseo normal de campos
                const patterns = [
                    // nombre  tipo   constraints
                    /^\s*`?([a-zA-Z_][a-zA-Z0-9_]*)`?\s+([A-Z]+(?:\(\d+(?:,\d+)?\))?)\s+(.*)$/i, // con constraints
                    /^\s*`?([a-zA-Z_][a-zA-Z0-9_]*)`?\s+([A-Z]+(?:\(\d+(?:,\d+)?\))?)\s*$/i,     // sin constraints
                ];

                let matched = false;
                for (const p of patterns) {
                    const m = line.match(p);
                    if (m) {
                        const name = m[1];
                        const type = (m[2] || '').toUpperCase();
                        const constraints = (m[3] || '').toUpperCase();

                        const isPrimary = /\bPRIMARY\s+KEY\b/i.test(constraints);
                        const isAuto = /\bAUTO_INCREMENT\b/i.test(constraints);

                        fields.push({
                            name,
                            type: type.startsWith('VARCHAR') ? 'VARCHAR' : type,
                            isPrimary,
                            isAuto,
                            isForeign: false,
                            referencesTable: null,
                            referencesField: null
                        });

                        console.log(`  ✓ Campo agregado: ${name} (${type.startsWith('VARCHAR') ? 'VARCHAR' : type})`);
                        matched = true;
                        break;
                    }
                }

                if (!matched) {
                    console.log(`   ✗ No se pudo parsear: ${line}`);
                }
            }

            console.log("Campos parseados:", fields);
            return { fields, inlineRelations };
        }


        /**
         * Divide por comas de forma inteligente, respetando paréntesis, comillas y unicode
         */
        function smartSplitByComma(text) {
            const parts = [];
            let current = '';
            let parenLevel = 0;
            let inSingleQuote = false;
            let inDoubleQuote = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];

                // Manejo de comillas
                if (char === "'" && !inDoubleQuote) {
                    inSingleQuote = !inSingleQuote;
                    current += char;
                    continue;
                }
                if (char === '"' && !inSingleQuote) {
                    inDoubleQuote = !inDoubleQuote;
                    current += char;
                    continue;
                }

                // Manejo de paréntesis
                if (char === '(' && !inSingleQuote && !inDoubleQuote) {
                    parenLevel++;
                    current += char;
                    continue;
                }
                if (char === ')' && !inSingleQuote && !inDoubleQuote) {
                    parenLevel = Math.max(0, parenLevel - 1);
                    current += char;
                    continue;
                }

                // Split por coma solo si NO está dentro de paréntesis ni comillas
                if (char === ',' && parenLevel === 0 && !inSingleQuote && !inDoubleQuote) {
                    if (current.trim()) {
                        parts.push(current.trim());
                    }
                    current = '';
                } else {
                    current += char;
                }
            }

            if (current.trim()) {
                parts.push(current.trim());
            }

            // Normalizar: cerrar paréntesis abiertos y limpiar saltos
            for (let i = 0; i < parts.length; i++) {
                let open = (parts[i].match(/\(/g) || []).length;
                let close = (parts[i].match(/\)/g) || []).length;
                if (open > close) {
                    parts[i] = parts[i] + ')';  // completa paréntesis faltante
                }

                // 🔧 FIX: si es un FOREIGN KEY con REFERENCES truncado, ciérralo
                if (/REFERENCES\s+\w+\s*\(\s*\w+$/.test(parts[i])) {
                    parts[i] = parts[i] + ')';
                }

                parts[i] = parts[i].replace(/\n+/g, ' ').trim();
            }

            // 🟢 DEBUG opcional
            console.log("🔎 smartSplitByComma →", parts);

            return parts;
        }




        /**
         * Verifica si una línea debe ser ignorada (constraints, comentarios, etc.)
         */
        function shouldIgnoreLine(line) {
            const upper = line.toUpperCase().trim();

            // No ignores líneas que empiezan con un nombre de campo (columna + tipo)
            const startsWithColumn = /^\s*`?[A-Z_][A-Z0-9_]*`?\s+[A-Z]+/i.test(line);
            if (startsWithColumn) return false;

            // Ignorar solo constraints de tabla, índices y comentarios
            return (
                // PRIMARY KEY(...) / UNIQUE(...) / CHECK(...)
                /\bPRIMARY\s+KEY\s*\(/i.test(upper) ||
                /\bUNIQUE\s*\(/i.test(upper) ||
                /\bCHECK\s*\(/i.test(upper) ||
                // FOREIGN KEY(...) — OJO: no lo ignoramos aquí, lo captura antes el regex tolerante
                (/\bFOREIGN\s+KEY\b/i.test(upper) && /\(/.test(line)) ||
                // Otros
                /\bCONSTRAINT\b/i.test(upper) ||
                /\bINDEX\b/i.test(upper) ||
                /^\s*--/.test(line) ||
                /^\s*\/\*/.test(line) ||
                // KEY (...) que no comienza como columna
                (/\bKEY\b/i.test(upper) && /\(/.test(line) && !/^\s*\w+\s+/i.test(line))
            );
        }



        // ===== FUNCIÓN MEJORADA PARA PARSEAR LÍNEAS DE CAMPOS =====
        function parseFieldLine(line, tableName) {
            line = line.trim();

            // 🟢 1. Detectar FOREIGN KEY (mejorado para manejar paréntesis no cerrados)
            const fkRegex = /FOREIGN\s+KEY\s*\(([^)]+)\)\s*REFERENCES\s+([^(]+)\(([^)]*)/i;
            if (fkRegex.test(line)) {
                const fkMatch = line.match(fkRegex);
                if (fkMatch) {
                    const fieldName = fkMatch[1].trim().replace(/`/g, '');
                    const refTable = fkMatch[2].trim().replace(/`/g, '');
                    // Manejar caso donde el campo referenciado podría no estar completo
                    let refField = (fkMatch[3] || '').trim().replace(/`/g, '');

                    // Limpiar paréntesis sobrantes
                    refField = refField.replace(/\)+$/, '');

                    // Si no se especificó campo, usar el mismo nombre o "id"
                    if (!refField) {
                        refField = fieldName.replace(/_id$/, '') + '_id';
                        if (refField === fieldName + '_id') refField = 'id';
                    }

                    console.log(`    ✓ Relación detectada (inline): ${tableName}.${fieldName} → ${refTable}.${refField}`);

                    return {
                        name: fieldName,
                        type: "FOREIGN_KEY",
                        originalType: "FK",
                        isPrimary: false,
                        isForeign: true,
                        isNotNull: false,
                        isUnique: false,
                        defaultValue: null,
                        referencesTable: refTable,
                        referencesField: refField
                    };
                }
            }

            // 🟡 2. Patrones para campos normales (sin cambios)
            const patterns = [
                // Patrón 0: campo con PRIMARY KEY inline
                /^\s*`?([\p{L}_][\p{L}0-9_ñÑáéíóúÁÉÍÓÚ]*)`?\s+([A-Za-z0-9]+(?:\([^)]*\))?)\s+(PRIMARY\s+KEY.*)$/iu,

                // Patrón 1: campo con constraints
                /^\s*`?([\p{L}_][\p{L}0-9_ñÑáéíóúÁÉÍÓÚ]*)`?\s+([A-Za-z0-9]+(?:\([^)]*\)?)?)\s+(AUTO_INCREMENT|NOT\s+NULL|UNIQUE|DEFAULT\s+[^,\s]+(?:\s+[^,]*)?|REFERENCES\s+\S+(?:\s*\([^)]*\))?.*)$/iu,

                // Patrón 2: campo solo con nombre + tipo
                /^\s*`?([\p{L}_][\p{L}0-9_ñÑáéíóúÁÉÍÓÚ]*)`?\s+([A-Za-z0-9]+(?:\([^)]*\)?)?)\s*$/iu,

                // Patrón 3: campo solo con nombre
                /^\s*`?([\p{L}_][\p{L}0-9_ñÑáéíóúÁÉÍÓÚ]*)`?\s*$/iu
            ];

            for (let i = 0; i < patterns.length; i++) {
                const match = line.match(patterns[i]);
                if (match) {
                    const fieldName = match[1];
                    let dataType = match[2] || 'VARCHAR(255)';
                    const constraints = match[3] || '';

                    // 🔧 FIX: cerrar paréntesis en el tipo de dato si quedó abierto
                    if (dataType.includes("(") && !dataType.includes(")")) {
                        dataType = dataType + ")";
                    }

                    // Limpiar tipo de datos
                    dataType = dataType.trim().replace(/[,\s]*$/, '');

                    console.log(`    Patrón ${i} matched: nombre="${fieldName}", tipo="${dataType}", constraints="${constraints}"`);

                    const originalType = String(dataType || "").trim();
                    const baseType = normalizeDataType(originalType);
                    const lenMatch = originalType.match(/\(([^)]+)\)/);
                    const typeLength = lenMatch ? lenMatch[1].trim() : null;

                    return {
                        name: fieldName,
                        type: baseType,
                        originalType: originalType.toUpperCase(),
                        typeLength: typeLength,
                        isPrimary: constraints.toUpperCase().includes('PRIMARY KEY') ||
                            constraints.toUpperCase().includes('AUTO_INCREMENT') ||
                            dataType.toUpperCase().includes('PRIMARY KEY'),
                        isForeign: constraints.toUpperCase().includes('REFERENCES'),
                        isNotNull: constraints.toUpperCase().includes('NOT NULL'),
                        isUnique: constraints.toUpperCase().includes('UNIQUE'),
                        defaultValue: extractDefault(constraints),
                        referencesTable: extractReferences(constraints),
                        referencesField: extractReferencesField(constraints)
                    };
                }
            }

            console.log("   ✗ No se pudo parsear:", line);
            return null;
        }




        /**
         * Normaliza tipos de datos SQL
         */
        function normalizeDataType(type) {
            const upperType = type.toUpperCase().trim();

            if (upperType.includes('INT')) return 'INT';
            if (upperType.includes('VARCHAR')) return 'VARCHAR';
            if (upperType.includes('TEXT')) return 'TEXT';
            if (upperType.includes('DATE') && !upperType.includes('TIME')) return 'DATE';
            if (upperType.includes('DATETIME') || upperType.includes('TIMESTAMP')) return 'DATETIME';
            if (upperType.includes('DECIMAL') || upperType.includes('FLOAT') || upperType.includes('DOUBLE')) return 'DECIMAL';
            if (upperType.includes('BOOL')) return 'BOOLEAN';

            return upperType;
        }

        /**
         * Extrae valor por defecto
         */
        function extractDefault(constraints) {
            const defaultMatch = constraints.match(/DEFAULT\s+['"']?([^'"',\s]+)['"']?/i);
            return defaultMatch ? defaultMatch[1] : null;
        }

        /**
         * Extrae tabla referenciada
         */
        function extractReferences(constraints) {
            const refMatch = constraints.match(/REFERENCES\s+`?(\w+)`?/i);
            return refMatch ? refMatch[1] : null;
        }

        /**
         * Extrae campo referenciado
         */
        function extractReferencesField(constraints) {
            const refMatch = constraints.match(/REFERENCES\s+`?\w+`?\s*\(\s*`?(\w+)`?\s*\)/i);
            return refMatch ? refMatch[1] : null;
        }

        // ===== FUNCIÓN MEJORADA PARA DETECTAR RELACIONES EN LÍNEAS SEPARADAS =====
        function parseSQLRelationships(sqlCode, tables) {
            const relationships = [];
            console.log("=== PARSEANDO RELACIONES ===");

            // 1. Buscar FOREIGN KEYs en ALTER TABLE (mejorado)
            const alterTableRegex =
                /ALTER\s+TABLE\s+`?(\w+)`?\s+ADD\s+(?:CONSTRAINT\s+\w+\s+)?FOREIGN\s+KEY\s*\(\s*`?(\w+)`?\s*\)\s+REFERENCES\s+`?(\w+)`?\s*\(\s*`?(\w+)`?\s*\)/gi;

            let match;
            while ((match = alterTableRegex.exec(sqlCode)) !== null) {
                const fromTable = match[1];
                const fromField = match[2];
                const toTable = match[3];
                const toField = match[4];

                relationships.push({
                    fromTable: fromTable,
                    toTable: toTable,
                    fromField: fromField,
                    toField: toField,
                    type: "1:N"
                });
                console.log(`  → FK Constraint encontrado: ${fromTable}.${fromField} → ${toTable}.${toField}`);
            }

            // 2. Buscar FOREIGN KEYs en CREATE TABLE (líneas separadas)
            const createTableFkRegex =
                /FOREIGN\s+KEY\s*\(\s*`?(\w+)`?\s*\)\s+REFERENCES\s+`?(\w+)`?\s*\(\s*`?(\w+)`?\s*\)/gi;

            let fkMatch;
            while ((fkMatch = createTableFkRegex.exec(sqlCode)) !== null) {
                // Encontrar el nombre de la tabla a la que pertenece este FK
                const tableStart = sqlCode.lastIndexOf('CREATE TABLE', fkMatch.index);
                if (tableStart !== -1) {
                    const tableNameMatch = sqlCode.substring(tableStart, fkMatch.index).match(/CREATE\s+TABLE\s+`?(\w+)`?/i);
                    if (tableNameMatch) {
                        const fromTable = tableNameMatch[1];
                        const fromField = fkMatch[1];
                        const toTable = fkMatch[2];
                        const toField = fkMatch[3];

                        relationships.push({
                            fromTable: fromTable,
                            toTable: toTable,
                            fromField: fromField,
                            toField: toField,
                            type: "1:N"
                        });
                        console.log(`  → FK en CREATE TABLE: ${fromTable}.${fromField} → ${toTable}.${toField}`);
                    }
                }
            }

            // 3. Incluir relaciones inline detectadas durante el parseo de campos
            for (const table of tables) {
                if (table.inlineRelations) {
                    for (const rel of table.inlineRelations) {
                        relationships.push(rel);
                        console.log(`  ✓ Relación inline agregada: ${rel.fromTable}.${rel.fromField} → ${rel.toTable}.${rel.toField}`);
                    }
                }
            }

            // 4. Revisar campos con referencia explícita
            tables.forEach(table => {
                console.log(`Verificando tabla: ${table.name}`);

                table.fields.forEach(field => {
                    console.log(`  Campo: ${field.name}, es FK: ${field.isForeign}, referencia: ${field.referencesTable}.${field.referencesField}`);

                    if (field.isForeign && field.referencesTable) {
                        relationships.push({
                            fromTable: table.name,
                            toTable: field.referencesTable,
                            fromField: field.name,
                            toField: field.referencesField || "id",
                            type: "1:N"
                        });
                        console.log(`  → Relación encontrada: ${table.name}.${field.name} → ${field.referencesTable}.${field.referencesField || "id"}`);
                    }
                });
            });

            // 5. Fallback: Inferir por nombres de campos si no hay ninguna FK explícita
            if (relationships.length === 0) {
                console.log("⚠️ No se encontraron FKs explícitas, infiriendo por nombres...");

                tables.forEach(table => {
                    table.fields.forEach(field => {
                        const fieldName = field.name.toLowerCase();

                        if ((fieldName.includes("id") && fieldName !== "id" && !field.isPrimary) ||
                            fieldName.endsWith("_id")) {
                            tables.forEach(otherTable => {
                                if (otherTable.name !== table.name) {
                                    const tableName = otherTable.name.toLowerCase();

                                    if (
                                        fieldName === "id" + tableName ||
                                        fieldName === tableName + "id" ||
                                        fieldName === "id_" + tableName ||
                                        fieldName.includes(tableName) ||
                                        fieldName.endsWith("_id") && fieldName.replace(/_id$/, '') === tableName
                                    ) {
                                        relationships.push({
                                            fromTable: table.name,
                                            toTable: otherTable.name,
                                            fromField: field.name,
                                            toField: "id",
                                            type: "1:N"
                                        });
                                        console.log(`  → Relación inferida: ${table.name}.${field.name} → ${otherTable.name}.id`);
                                    }
                                }
                            });
                        }
                    });
                });
            }

            console.log(`Total relaciones encontradas: ${relationships.length}`);
            return relationships;
        }


        /**
         * Crea entidades en el workspace desde las tablas parseadas
         */
        function createEntitiesFromTables(tables, workspace) {
            const positions = calculateTablePositions(tables.length);

            tables.forEach((table, index) => {
                const entity = createEntityFromTable(table, positions[index]);
                workspace.appendChild(entity);
                makeEntityDraggable(entity);

                // Asignar ID único para referencias posteriores
                entity.setAttribute('data-table-name', table.name);
            });
        }

        /**
         * Calcula posiciones para las tablas
         */
        function calculateTablePositions(tableCount) {
            const positions = [];
            const cols = Math.ceil(Math.sqrt(tableCount));
            const spacing = { x: 250, y: 200 };
            const startPos = { x: 100, y: 100 };

            for (let i = 0; i < tableCount; i++) {
                const row = Math.floor(i / cols);
                const col = i % cols;

                positions.push({
                    x: startPos.x + (col * spacing.x),
                    y: startPos.y + (row * spacing.y)
                });
            }

            return positions;
        }

        /**
         * Crea una entidad DOM desde una tabla parseada
         */
        function createEntityFromTable(table, position) {
            const entity = document.createElement("div");
            entity.className = "er-element";
            entity.style.position = "absolute";
            entity.style.left = position.x + "px";
            entity.style.top = position.y + "px";
            entity.style.fontSize = "11px";
            entity.style.minWidth = "140px";
            entity.style.display = "inline-block";
            entity.style.background = "transparent";
            entity.style.padding = "0";
            entity.style.margin = "0";
            entity.style.boxShadow = "none";
            entity.style.textAlign = "center";

            const tableElement = document.createElement("table");
            tableElement.style.width = "auto";
            tableElement.style.borderCollapse = "collapse";
            tableElement.style.tableLayout = "auto";
            tableElement.style.userSelect = "none";

            const thStyle = "border:1px solid #111;padding:4px 8px;background:#f3f4f6;font-weight:700;text-align:center;font-size:11px;";
            const tdStyle = "border:1px solid #111;padding:2px 6px;text-align:left;font-size:11px;";

            // Crear header
            let html = `<thead><tr><th colspan="3" style="${thStyle}" contenteditable="true">${table.name}</th></tr></thead><tbody>`;

            // Crear filas para cada campo
            table.fields.forEach(field => {
                const keyIcon = field.isPrimary ? '<i class="fas fa-key" style="color: #f59e0b; font-size: 10px; margin-right: 4px;"></i>' :
                    field.isForeign ? '<i class="fas fa-external-link-alt" style="color: #8b5cf6; font-size: 9px; margin-right: 4px;"></i>' : '';

                // Mostrar el tipo completo (VARCHAR(100), DECIMAL(10,2), etc.)
                const displayType =
                    field.originalType?.trim() ||
                    (field.type + (field.typeLength ? `(${field.typeLength})` : ''));

                html += `<tr>
    <td style="${tdStyle}" contenteditable="false">${keyIcon}</td>
    <td style="${tdStyle}" contenteditable="true">${field.name}</td>
    <td style="${tdStyle}" contenteditable="true">${displayType}</td>
</tr>`;
            });

            html += "</tbody>";
            tableElement.innerHTML = html;
            entity.appendChild(tableElement);

            return entity;
        }

        /**
         * Crea relaciones desde los datos parseados
         */
        function createRelationshipsFromSQL(relationships, workspace) {
            console.log('=== CREANDO CONEXIONES VISUALES ===');
            console.log('Relaciones a crear:', relationships);

            if (!window.getOrCreateSVG) {
                console.error('Función getOrCreateSVG no disponible');
                return;
            }

            const svg = getOrCreateSVG(workspace);

            relationships.forEach((rel, index) => {
                console.log(`Creando relación ${index + 1}:`, rel);

                const fromEntity = workspace.querySelector(`[data-table-name="${rel.fromTable}"]`);
                const toEntity = workspace.querySelector(`[data-table-name="${rel.toTable}"]`);

                console.log('Entidad origen encontrada:', !!fromEntity);
                console.log('Entidad destino encontrada:', !!toEntity);

                if (fromEntity && toEntity) {
                    createConnectionBetweenEntities(fromEntity, toEntity, rel.type, svg, workspace);
                    console.log(`✓ Conexión creada entre ${rel.fromTable} y ${rel.toTable}`);
                } else {
                    console.log(`✗ No se pudo crear conexión entre ${rel.fromTable} y ${rel.toTable}`);
                }
            });
        }

        /**
         * Crea una conexión visual entre two entidades
         */
        function createConnectionBetweenEntities(entity1, entity2, type, svg, workspace) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("stroke", "#333");
            line.setAttribute("stroke-width", "2");
            line.id = `connection-sql-${Date.now()}`;
            svg.appendChild(line);

            // Crear etiquetas para el tipo de relación
            const label1 = createLabel("1");
            const labelN = createLabel("N");
            workspace.appendChild(label1);
            workspace.appendChild(labelN);

            // Calcular posiciones iniciales
            const rect1 = entity1.getBoundingClientRect();
            const rect2 = entity2.getBoundingClientRect();
            const workspaceRect = workspace.getBoundingClientRect();

            const x1 = rect1.right - workspaceRect.left;
            const y1 = rect1.top + rect1.height / 2 - workspaceRect.top;
            const x2 = rect2.left - workspaceRect.left;
            const y2 = rect2.top + rect2.height / 2 - workspaceRect.top;

            updateLine(line, label1, labelN, x1, y1, x2, y2);

            const conn = {
                line,
                label1,
                labelN,
                x1, y1, x2, y2,
                table1: entity1,
                tableN: entity2
            };

            allConnections.push(conn);
            if (window.makeConnectionDraggable) {
                makeConnectionDraggable(conn);
            }
        }

        /**
         * Limpia el workspace
         */
        function clearWorkspace() {
            const workspace = document.getElementById('workspaceArea');
            if (!workspace) return;

            // Remover todas las entidades
            const entities = workspace.querySelectorAll('.er-element');
            entities.forEach(entity => entity.remove());

            // Remover todas las conexiones
            const connections = workspace.querySelectorAll('.connections-layer');
            connections.forEach(conn => conn.remove());

            const labels = workspace.querySelectorAll('.connection-label');
            labels.forEach(label => label.remove());

            // Limpiar array de conexiones si existe
            if (window.allConnections) {
                allConnections.length = 0;
            }
            if (window.selectedConnection) {
                selectedConnection = null;
            }
        }

        // Hacer la función disponible globalmente
        window.parseQLToiagram = parseQLToiagram;

        // ===== FUNCIONES PARA ALTERNAR MODOS =====

        let currentMode = 'sql-to-diagram'; // 'sql-to-diagram' o 'diagram-to-sql'

        function toggleSQLFunction() {
            if (currentMode === 'sql-to-diagram') {
                parseQLToiagram();
            } else {
                generateSQL();
            }
        }

        function switchMode() {
            const mainButton = document.getElementById('mainSQLButton');
            const buttonText = document.getElementById('buttonText');
            const modeText = document.getElementById('modeText');
            const sqlEditor = document.getElementById('sqlEditor');

            if (currentMode === 'sql-to-diagram') {
                // Cambiar a modo diagrama → SQL
                currentMode = 'diagram-to-sql';
                buttonText.innerHTML = '<i class="fas fa-magic mr-2"></i>Generar SQL';
                modeText.textContent = 'Modo: Diagrama → SQL';
                sqlEditor.placeholder = `-- Tu código SQL aparecerá aquí...
-- Crea entidades en el diagrama y haz clic en "Generar SQL"
CREATE TABLE ejemplo (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nombre VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);`;

            } else {
                // Cambiar a modo SQL → diagrama
                currentMode = 'sql-to-diagram';
                buttonText.innerHTML = '<i class="fas fa-magic mr-2"></i>Generar Diagrama';
                modeText.textContent = 'Modo: SQL → Diagrama';
                sqlEditor.placeholder = `-- Pega tu código SQL aquí para generar un diagrama...
-- Ejemplo:
CREATE TABLE usuarios (
    id INT PRIMARY KEY AUTO_INCREMENT,
    nombre VARCHAR(100) NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE pedidos (
    id INT PRIMARY KEY AUTO_INCREMENT,
    usuario_id INT NOT NULL,
    total DECIMAL(10,2),
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (usuario_id) REFERENCES usuarios(id)
);`;
            }

            showNotification(`Modo cambiado a: ${modeText.textContent.replace('Modo: ', '')}`, 'info');
        }

        // Hacer funciones disponibles globalmente
        window.toggleSQLFunction = toggleSQLFunction;
        window.switchMode = switchMode;

    </script>
    <script>
        // ===== Crear área de trabajo con cuadrícula =====
        function createWorkspaceArea() {
            let workspace = document.getElementById("workspaceArea");

            if (!workspace) {
                const mainArea = document.querySelector(".relative.z-10.h-full.flex.items-center.justify-center.-mt-16");
                if (mainArea) {
                    mainArea.innerHTML = ""; // borrar bienvenida

                    workspace = document.createElement("div");
                    workspace.id = "workspaceArea";
                    workspace.style.position = "relative";
                    workspace.style.width = "100%";
                    workspace.style.height = "100%";
                    workspace.style.backgroundSize = "20px 20px";
                    workspace.style.backgroundImage =
                        "linear-gradient(to right, #e5e7eb 1px, transparent 1px), " +
                        "linear-gradient(to bottom, #e5e7eb 1px, transparent 1px)";
                    workspace.style.overflow = "hidden";
                    workspace.classList.add("rounded-lg", "shadow-inner", "bg-white");

                    mainArea.appendChild(workspace);
                }
            }
            return workspace;
        }

        // ===== Crear barra de herramientas global moderna en la esquina superior derecha =====
        function createGlobalToolbar() {
            // Verificar si ya existe
            if (document.getElementById("globalToolbar")) return;

            const toolbar = document.createElement("div");
            toolbar.id = "globalToolbar";
            toolbar.style.position = "fixed";
            toolbar.style.top = "80px"; // Debajo del header existente
            toolbar.style.right = "24px"; // Esquina superior derecha
            toolbar.style.backgroundColor = "rgba(255, 255, 255, 0.95)";
            toolbar.style.backdropFilter = "blur(20px)";
            toolbar.style.border = "1px solid rgba(226, 232, 240, 0.6)";
            toolbar.style.borderRadius = "20px"; // Más redondeado
            toolbar.style.padding = "12px 8px";
            toolbar.style.zIndex = "1000";
            toolbar.style.boxShadow = "0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)";
            toolbar.style.display = "flex";
            toolbar.style.flexDirection = "column";
            toolbar.style.gap = "8px";
            toolbar.style.maxWidth = "56px";
            toolbar.style.transition = "all 0.3s cubic-bezier(0.4, 0, 0.2, 1)";

            // Botones de la barra de herramientas con colores modernos
            const buttons = [
                { id: "btn-add-field", icon: "fas fa-plus", title: "Agregar Campo", action: "addField", color: "linear-gradient(135deg, #10b981, #059669)" },
                { id: "btn-remove-field", icon: "fas fa-minus", title: "Eliminar Campo", action: "removeField", color: "linear-gradient(135deg, #ef4444, #dc2626)" },
                { id: "btn-add-key", icon: "fas fa-key", title: "Agregar Llave", action: "addKey", color: "linear-gradient(135deg, #f59e0b, #d97706)" },
                { id: "btn-bold", icon: "fas fa-bold", title: "Negrita", action: "toggleBold", color: "linear-gradient(135deg, #6b7280, #374151)" },
                { id: "btn-font-family", icon: "fas fa-font", title: "Cambiar Fuente", action: "changeFontFamily", color: "linear-gradient(135deg, #06b6d4, #0891b2)" },
                { id: "btn-text-color", icon: "fas fa-palette", title: "Color Texto", action: "changeTextColor", color: "linear-gradient(135deg, #f97316, #ea580c)" },
                { id: "btn-bg-color", icon: "fas fa-fill-drip", title: "Color Fondo", action: "changeBgColor", color: "linear-gradient(135deg, #84cc16, #65a30d)" },
                { id: "btn-duplicate", icon: "fas fa-copy", title: "Duplicar", action: "duplicateEntity", color: "linear-gradient(135deg, #8b5cf6, #7c3aed)" },
                { id: "btn-delete", icon: "fas fa-trash", title: "Eliminar", action: "deleteEntity", color: "linear-gradient(135deg, #ef4444, #dc2626)" }
            ];

            buttons.forEach(btn => {
                const button = document.createElement("button");
                button.id = btn.id;
                button.innerHTML = `<i class="${btn.icon}"></i>`;
                button.title = btn.title;
                button.style.width = "40px";
                button.style.height = "40px";
                button.style.border = "none";
                button.style.borderRadius = "12px"; // Botones más redondeados
                button.style.background = btn.color;
                button.style.color = "white";
                button.style.cursor = "pointer";
                button.style.display = "flex";
                button.style.alignItems = "center";
                button.style.justifyContent = "center";
                button.style.fontSize = "14px";
                button.style.transition = "all 0.2s cubic-bezier(0.4, 0, 0.2, 1)";
                button.style.boxShadow = "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)";
                button.style.position = "relative";
                button.style.overflow = "hidden";

                // Efectos hover modernos
                button.addEventListener("mouseenter", () => {
                    button.style.transform = "translateY(-2px) scale(1.05)";
                    button.style.boxShadow = "0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)";
                });

                button.addEventListener("mouseleave", () => {
                    button.style.transform = "translateY(0) scale(1)";
                    button.style.boxShadow = "0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)";
                });

                // Efecto de click
                button.addEventListener("mousedown", () => {
                    button.style.transform = "translateY(-1px) scale(0.98)";
                });

                button.addEventListener("mouseup", () => {
                    button.style.transform = "translateY(-2px) scale(1.05)";
                });

                // Asignar acción
                button.addEventListener("click", () => {
                    handleToolbarAction(btn.action);
                });

                toolbar.appendChild(button);
            });

            // Efecto de entrada suave para el toolbar
            toolbar.style.opacity = "0";
            toolbar.style.transform = "translateY(-20px)";

            document.body.appendChild(toolbar);

            // Animación de entrada
            setTimeout(() => {
                toolbar.style.opacity = "1";
                toolbar.style.transform = "translateY(0)";
            }, 100);

            // Ocultar inicialmente
            toolbar.style.display = "none";
        }

        // ===== Mostrar barra de herramientas =====
        function showToolbar() {
            const toolbar = document.getElementById("globalToolbar");
            if (toolbar) {
                toolbar.style.display = "flex";
            }
        }

        // ===== Ocultar barra de herramientas =====
        function hideToolbar() {
            const toolbar = document.getElementById("globalToolbar");
            if (toolbar) {
                toolbar.style.display = "none";
            }
        }

        // ===== Manejar acciones de la barra de herramientas =====
        function handleToolbarAction(action) {
            const selectedEntity = document.querySelector(".selected-entity");
            if (!selectedEntity) return;

            switch (action) {
                case "addField":
                    addFieldToEntity(selectedEntity);
                    break;
                case "removeField":
                    removeFieldFromEntity(selectedEntity);
                    break;
                case "addKey":
                    addKeyToEntity(selectedEntity);
                    break;
                case "toggleBold":
                    toggleTextStyle(selectedEntity, "fontWeight", "bold", "normal");
                    break;
                case "changeFontFamily":
                    changeFontFamily(selectedEntity);
                    break;
                case "changeTextColor":
                    changeTextColor(selectedEntity);
                    break;
                case "changeBgColor":
                    changeBgColor(selectedEntity);
                    break;
                case "duplicateEntity":
                    duplicateEntity(selectedEntity);
                    break;
                case "deleteEntity":
                    deleteEntity(selectedEntity);
                    break;
            }
        }

        // ===== Funciones para manipular entidades (sin notificaciones) =====
        function toggleTextStyle(entity, styleProperty, value1, value2) {
            const cells = entity.querySelectorAll("td, th");
            cells.forEach(cell => {
                const currentValue = cell.style[styleProperty];
                cell.style[styleProperty] = currentValue === value1 ? value2 : value1;
            });
        }

        function changeTextColor(entity) {
            const colors = [
                "#000000", // Negro
                "#dc2626", // Rojo
                "#059669", // Verde
                "#2563eb", // Azul
                "#7c3aed", // Púrpura
                "#f59e0b", // Amarillo/Naranja
                "#ec4899", // Rosa
                "#06b6d4"  // Cian
            ];

            const cells = entity.querySelectorAll("td, th");

            // Obtener el índice actual desde un atributo personalizado o empezar en 0
            let currentIndex = parseInt(entity.getAttribute("data-color-index")) || 0;

            // Avanzar al siguiente color
            currentIndex = (currentIndex + 1) % colors.length;

            // Guardar el índice actual
            entity.setAttribute("data-color-index", currentIndex);

            // Aplicar el color a todas las celdas
            cells.forEach(cell => {
                cell.style.color = colors[currentIndex];
            });
        }

        function changeBgColor(entity) {
            const colors = [
                "#f3f4f6", // Gris claro
                "#fee2e2", // Rosa claro
                "#dcfce7", // Verde claro
                "#dbeafe", // Azul claro
                "#fef3c7", // Amarillo claro
                "#e9d5ff", // Púrpura claro
                "#fce7f3", // Magenta claro
                "#cffafe"  // Cian claro
            ];

            const header = entity.querySelector("th");

            // Obtener el índice actual desde un atributo personalizado o empezar en 0
            let currentIndex = parseInt(entity.getAttribute("data-bg-index")) || 0;

            // Avanzar al siguiente color
            currentIndex = (currentIndex + 1) % colors.length;

            // Guardar el índice actual
            entity.setAttribute("data-bg-index", currentIndex);

            // Aplicar el color de fondo al header
            header.style.backgroundColor = colors[currentIndex];
        }

        function changeFontFamily(entity) {
            const fonts = [
                "Arial, sans-serif",
                "Georgia, serif",
                "'Courier New', monospace",
                "'Helvetica', sans-serif",
                "'Times New Roman', serif",
                "'Verdana', sans-serif",
                "'Comic Sans MS', cursive",
                "'Trebuchet MS', sans-serif"
            ];

            const cells = entity.querySelectorAll("td, th");

            // Obtener el índice actual desde un atributo personalizado o empezar en 0
            let currentIndex = parseInt(entity.getAttribute("data-font-index")) || 0;

            // Avanzar a la siguiente fuente
            currentIndex = (currentIndex + 1) % fonts.length;

            // Guardar el índice actual
            entity.setAttribute("data-font-index", currentIndex);

            // Aplicar la fuente a todas las celdas
            cells.forEach(cell => {
                cell.style.fontFamily = fonts[currentIndex];
            });
        }

        function duplicateEntity(entity) {
            const clone = entity.cloneNode(true);
            clone.style.left = (parseInt(entity.style.left) + 20) + "px";
            clone.style.top = (parseInt(entity.style.top) + 20) + "px";
            clone.classList.remove("selected-entity");

            entity.parentNode.appendChild(clone);
            makeEntityDraggable(clone);
        }

        function deleteEntity(entity) {
            if (confirm("¿Estás seguro de eliminar esta entidad?")) {
                entity.remove();

                // Ocultar toolbar si no hay más entidades
                const entities = document.querySelectorAll(".er-element");
                if (entities.length === 0) {
                    hideToolbar();
                }
            }
        }

        // ===== Hacer entidades arrastrables =====
        function makeEntityDraggable(entity) {
            let offsetX = 0, offsetY = 0, isDragging = false;

            entity.addEventListener("mousedown", (e) => {
                isDragging = true;
                // Remover selección previa
                document.querySelectorAll(".selected-entity").forEach(el => {
                    el.classList.remove("selected-entity");
                    el.style.boxShadow = "none";
                });

                entity.classList.add("selected-entity");
                offsetX = e.clientX - entity.offsetLeft;
                offsetY = e.clientY - entity.offsetTop;
                entity.style.zIndex = "1000";

                // Efecto visual de selección
                entity.style.boxShadow = "0 0 0 2px #3b82f6";
            });

            document.addEventListener("mousemove", (e) => {
                if (isDragging) {
                    entity.style.position = "absolute";
                    entity.style.left = (e.clientX - offsetX) + "px";
                    entity.style.top = (e.clientY - offsetY) + "px";
                }
            });

            document.addEventListener("mouseup", () => {
                isDragging = false;
                entity.style.zIndex = "1";
            });

            document.addEventListener("click", (e) => {
                if (!entity.contains(e.target) && !e.target.closest("#globalToolbar")) {
                    entity.classList.remove("selected-entity");
                    entity.style.boxShadow = "none";
                }
            });
        }

        // ===== Funciones existentes que deben mantenerse =====
        function addFieldToEntity(entity) {
            const table = entity.querySelector("table");
            const tbody = table.querySelector("tbody");
            const firstRow = tbody.querySelector("tr");

            if (!firstRow) return;

            const colCount = firstRow.cells.length;
            const newRow = document.createElement("tr");

            for (let i = 0; i < colCount; i++) {
                const cell = document.createElement("td");
                cell.style.border = "1px solid #111";
                cell.style.padding = "2px 4px";
                cell.style.textAlign = "left";
                cell.style.fontSize = "11px";
                cell.contentEditable = "true";

                if (i === 0 && colCount > 1) {
                    cell.textContent = "Field";
                } else if (i === 1 && colCount === 3) {
                    cell.textContent = "Type";
                } else {
                    cell.textContent = "Value";
                }

                newRow.appendChild(cell);
            }

            tbody.appendChild(newRow);
        }

        function removeFieldFromEntity(entity) {
            const table = entity.querySelector("table");
            const tbody = table.querySelector("tbody");
            const rows = tbody.querySelectorAll("tr");

            if (rows.length > 1) {
                tbody.removeChild(rows[rows.length - 1]);
            }
        }

        function addKeyToEntity(entity) {
            const table = entity.querySelector("table");
            const header = table.querySelector("th");
            const tbody = table.querySelector("tbody");
            const rows = tbody.querySelectorAll("tr");

            const firstRow = rows[0];
            const hasKey = firstRow.querySelector(".fa-key") !== null;

            if (hasKey) return;

            const currentColspan = parseInt(header.getAttribute("colspan") || 1);
            header.setAttribute("colspan", currentColspan + 1);

            rows.forEach(row => {
                const keyCell = document.createElement("td");
                keyCell.style.border = "1px solid #111";
                keyCell.style.padding = "2px 4px";
                keyCell.style.textAlign = "left";
                keyCell.style.fontSize = "11px";

                if (row === rows[0]) {
                    keyCell.innerHTML = '<i class="fas fa-key" style="color: #f59e0b; font-size: 10px;"></i>';
                    keyCell.contentEditable = "false";
                } else {
                    keyCell.contentEditable = "true";
                    keyCell.textContent = "Key";
                }

                row.insertBefore(keyCell, row.firstChild);
            });
        }

        // ===== Normaliza el tipo que viene del data-entity =====
        function normalizeType(raw) {
            const s = String(raw || "")
                .toLowerCase()
                .normalize("NFD").replace(/\p{Diacritic}/gu, "")
                .trim()
                .replace(/\s+/g, "-");

            if (s.includes("simple")) return "simple";
            if (s.includes("llave") || s.includes("llaves")) return "con-llaves";
            if (s.includes("tipo") || s.includes("tipos")) return "con-tipos";
            if (s.includes("completa")) return "completa";
            return "simple";
        }

        function addEntityToWorkspace(type) {
            const kind = normalizeType(type);
            const entity = document.createElement("div");
            entity.className = "er-element";
            entity.style.position = "absolute";
            entity.style.left = "50px";
            entity.style.top = "50px";
            entity.style.fontSize = "11px";
            entity.style.minWidth = "120px";
            entity.style.display = "inline-block";
            entity.style.background = "transparent";
            entity.style.padding = "0";
            entity.style.margin = "0";
            entity.style.boxShadow = "none";
            entity.style.textAlign = "center";

            const table = document.createElement("table");
            table.style.width = "auto";
            table.style.borderCollapse = "collapse";
            table.style.tableLayout = "auto";
            table.style.userSelect = "none";

            const thStyle = "border:1px solid #111;padding:2px 4px;background:#f3f4f6;font-weight:700;text-align:center;font-size:11px;";
            const tdStyle = "border:1px solid #111;padding:2px 4px;text-align:left;font-size:11px;";

            const cols = (kind === "simple") ? 1 : (kind === "completa" ? 3 : 2);

            let html = `<thead><tr><th colspan="${cols}" style="${thStyle}" contenteditable="true">Entity</th></tr></thead><tbody>`;

            const makeRows = (cells, n = 3) => {
                let out = "";
                for (let i = 0; i < n; i++) {
                    out += "<tr>" + cells.map(c => `<td style="${tdStyle}" contenteditable="true">${c}</td>`).join("") + "</tr>";
                }
                return out;
            };

            if (kind === "simple") {
                html += makeRows(["Field"], 3);
            } else if (kind === "con-llaves") {
                html += makeRows(["Key", "Field"], 3);
            } else if (kind === "con-tipos") {
                html += makeRows(["Field", "Type"], 3);
            } else if (kind === "completa") {
                html += makeRows(["Key", "Field", "Type"], 3);
            }

            html += "</tbody>";
            table.innerHTML = html;
            entity.appendChild(table);

            const addRowBtn = document.createElement("button");
            addRowBtn.innerText = "+";
            addRowBtn.style.marginTop = "4px";
            addRowBtn.style.padding = "2px 6px";
            addRowBtn.style.border = "1px solid #111";
            addRowBtn.style.borderRadius = "4px";
            addRowBtn.style.cursor = "pointer";
            addRowBtn.style.fontSize = "12px";
            addRowBtn.style.background = "#f3f4f6";

            addRowBtn.addEventListener("click", () => {
                const newRow = document.createElement("tr");
                if (kind === "simple") {
                    newRow.innerHTML = `<td style="${tdStyle}" contenteditable="true">Field</td>`;
                } else if (kind === "con-llaves") {
                    newRow.innerHTML = `<td style="${tdStyle}" contenteditable="true">Key</td>
                                <td style="${tdStyle}" contenteditable="true">Field</td>`;
                } else if (kind === "con-tipos") {
                    newRow.innerHTML = `<td style="${tdStyle}" contenteditable="true">Field</td>
                                <td style="${tdStyle}" contenteditable="true">Type</td>`;
                } else if (kind === "completa") {
                    newRow.innerHTML = `<td style="${tdStyle}" contenteditable="true">Key</td>
                                <td style="${tdStyle}" contenteditable="true">Field</td>
                                <td style="${tdStyle}" contenteditable="true">Type</td>`;
                }
                table.querySelector("tbody").appendChild(newRow);
            });

            entity.appendChild(addRowBtn);

            // Mostrar toolbar cuando se crea la primera entidad
            const entities = document.querySelectorAll(".er-element");
            if (entities.length === 0) {
                createGlobalToolbar();
                showToolbar();
            }

            return entity;
        }

        // ===== Escuchar clics del menú =====
        document.addEventListener("DOMContentLoaded", () => {
            document.addEventListener("click", (e) => {
                const option = e.target.closest(".entity-option");
                if (!option) return;
                const entityType = option.dataset.entity;

                if (entityType === "conexion-uno-muchos") {
                    const workspace = document.getElementById("workspaceArea") || createWorkspaceArea();
                    addConnectionToWorkspace();
                    return;
                }

                const workspace = createWorkspaceArea();
                const newEntity = addEntityToWorkspace(entityType);
                if (newEntity) {
                    workspace.appendChild(newEntity);
                    makeEntityDraggable(newEntity);
                }
            });
        });
    </script>
    <script>
        // ====== SCRIPT DE CONEXIONES 1:N ======
        let connectionCounter = 0;
        let selectedConnection = null;
        let allConnections = [];

        function addConnectionToWorkspace() {
            const workspace = document.getElementById("workspaceArea");
            if (!workspace) return;

            const svg = getOrCreateSVG(workspace);

            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("stroke", "#333");
            line.setAttribute("stroke-width", "2");
            line.id = `connection-${++connectionCounter}`;
            svg.appendChild(line);

            const label1 = createLabel("1");
            const labelN = createLabel("N");
            workspace.appendChild(label1);
            workspace.appendChild(labelN);

            let x1 = 150, y1 = 150, x2 = 280, y2 = 180;
            updateLine(line, label1, labelN, x1, y1, x2, y2);

            const conn = { line, label1, labelN, x1, y1, x2, y2, table1: null, tableN: null };
            allConnections.push(conn);

            makeConnectionDraggable(conn);
        }

        function getOrCreateSVG(workspace) {
            let svg = workspace.querySelector("svg.connections-layer");
            if (!svg) {
                svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.classList.add("connections-layer");
                svg.style.position = "absolute";
                svg.style.top = "0";
                svg.style.left = "0";
                svg.style.width = "100%";
                svg.style.height = "100%";
                workspace.insertBefore(svg, workspace.firstChild);
            }
            return svg;
        }

        function createLabel(text) {
            const lbl = document.createElement("div");
            lbl.innerText = text;
            lbl.className = "connection-label";
            lbl.style.position = "absolute";
            lbl.style.fontSize = "14px";
            lbl.style.fontWeight = "bold";
            lbl.style.color = "#111";
            lbl.style.userSelect = "none";
            lbl.style.cursor = "grab";
            return lbl;
        }

        function updateLine(line, lbl1, lblN, x1, y1, x2, y2) {
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);

            lbl1.style.left = (x1 - 6) + "px";
            lbl1.style.top = (y1 - 20) + "px";

            lblN.style.left = (x2 - 6) + "px";
            lblN.style.top = (y2 - 20) + "px";
        }

        // Enganchar al borde más lógico (cara que mira a la otra tabla)
        function snapToTable(x, y, otherX, otherY) {
            const workspace = document.getElementById("workspaceArea");
            const tables = workspace.querySelectorAll(".er-element table");
            const wsRect = workspace.getBoundingClientRect();

            for (let tbl of tables) {
                const rect = tbl.getBoundingClientRect();
                const left = rect.left - wsRect.left;
                const top = rect.top - wsRect.top;
                const right = left + rect.width;
                const bottom = top + rect.height;
                const cx = (left + right) / 2;
                const cy = (top + bottom) / 2;

                const margin = 20;
                const hitbox = {
                    left: left - margin,
                    top: top - margin,
                    right: right + margin,
                    bottom: bottom + margin
                };

                if (x >= hitbox.left && x <= hitbox.right && y >= hitbox.top && y <= hitbox.bottom) {
                    // calcular desde qué lado enganchar según dónde está el otro extremo
                    const dx = otherX - cx;
                    const dy = otherY - cy;

                    let snapX, snapY;
                    if (Math.abs(dx) > Math.abs(dy)) {
                        if (dx < 0) { // otro a la izquierda
                            snapX = left;
                            snapY = cy;
                        } else { // otro a la derecha
                            snapX = right;
                            snapY = cy;
                        }
                    } else {
                        if (dy < 0) { // otro arriba
                            snapX = cx;
                            snapY = top;
                        } else { // otro abajo
                            snapX = cx;
                            snapY = bottom;
                        }
                    }
                    return { tbl: tbl.closest(".er-element"), x: snapX, y: snapY };
                }
            }

            return null;
        }

        function makeConnectionDraggable(conn) {
            const { line, label1, labelN } = conn;
            let dragging = null;

            function startDrag(e, point) {
                dragging = point;
                selectedConnection = conn;
                highlightConnection(conn, true);
                e.preventDefault();
            }

            function drag(e) {
                if (!dragging) return;
                const workspace = document.getElementById("workspaceArea");
                const rect = workspace.getBoundingClientRect();

                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;

                let otherX = dragging === "1" ? conn.x2 : conn.x1;
                let otherY = dragging === "1" ? conn.y2 : conn.y1;

                const snap = snapToTable(x, y, otherX, otherY);
                if (snap) {
                    x = snap.x;
                    y = snap.y;
                    if (dragging === "1") conn.table1 = snap.tbl;
                    if (dragging === "N") conn.tableN = snap.tbl;
                }

                if (dragging === "1") {
                    conn.x1 = x;
                    conn.y1 = y;
                } else if (dragging === "N") {
                    conn.x2 = x;
                    conn.y2 = y;
                }

                updateLine(line, label1, labelN, conn.x1, conn.y1, conn.x2, conn.y2);
            }

            function stopDrag() {
                dragging = null;
            }

            label1.addEventListener("mousedown", (e) => startDrag(e, "1"));
            labelN.addEventListener("mousedown", (e) => startDrag(e, "N"));
            document.addEventListener("mousemove", drag);
            document.addEventListener("mouseup", stopDrag);

            line.addEventListener("click", () => {
                selectedConnection = conn;
                highlightConnection(conn, true);
            });
        }

        function highlightConnection(conn, active) {
            conn.line.setAttribute("stroke", active ? "red" : "#333");
        }

        document.addEventListener("keydown", (e) => {
            if ((e.key === "Delete" || e.key === "Backspace") && selectedConnection) {
                e.preventDefault();
                selectedConnection.line.remove();
                selectedConnection.label1.remove();
                selectedConnection.labelN.remove();
                allConnections = allConnections.filter(c => c !== selectedConnection);
                selectedConnection = null;
            }
        });

        function refreshConnections() {
            const workspace = document.getElementById("workspaceArea");
            const wsRect = workspace.getBoundingClientRect();

            allConnections.forEach(conn => {
                if (conn.table1 && conn.tableN) {
                    const rect1 = conn.table1.querySelector("table").getBoundingClientRect();
                    const rect2 = conn.tableN.querySelector("table").getBoundingClientRect();

                    const cx1 = rect1.left - wsRect.left + rect1.width / 2;
                    const cy1 = rect1.top - wsRect.top + rect1.height / 2;
                    const cx2 = rect2.left - wsRect.left + rect2.width / 2;
                    const cy2 = rect2.top - wsRect.top + rect2.height / 2;

                    // calcular caras opuestas
                    if (Math.abs(cx1 - cx2) > Math.abs(cy1 - cy2)) {
                        // izquierda / derecha
                        conn.x1 = (cx1 < cx2) ? rect1.right - wsRect.left : rect1.left - wsRect.left;
                        conn.y1 = cy1;
                        conn.x2 = (cx2 < cx1) ? rect2.right - wsRect.left : rect2.left - wsRect.left;
                        conn.y2 = cy2;
                    } else {
                        // arriba / abajo
                        conn.x1 = cx1;
                        conn.y1 = (cy1 < cy2) ? rect1.bottom - wsRect.top : rect1.top - wsRect.top;
                        conn.x2 = cx2;
                        conn.y2 = (cy2 < cy1) ? rect2.bottom - wsRect.top : rect2.top - wsRect.top;
                    }
                }
                updateLine(conn.line, conn.label1, conn.labelN, conn.x1, conn.y1, conn.x2, conn.y2);
            });
        }

        document.addEventListener("mousemove", () => {
            refreshConnections();
        });
    </script>
    <script>
        // ===== SCRIPT DE EXPORTACIÓN DE IMÁGENES =====

        /**
         * Exporta el área de trabajo como imagen PNG
         */
        function exportWorkspaceAsPNG() {
            const workspace = document.getElementById('workspaceArea');

            if (!workspace) {
                showNotification('No se encontró el área de trabajo', 'error');
                return;
            }

            // Verificar si hay contenido para exportar
            const entities = workspace.querySelectorAll('.er-element');
            const connections = workspace.querySelectorAll('.connections-layer line');

            if (entities.length === 0 && connections.length === 0) {
                showNotification('No hay contenido para exportar', 'warning');
                return;
            }

            // Mostrar indicador de carga
            showExportLoader('Generando imagen PNG...');

            // Usar html2canvas para capturar el workspace
            html2canvas(workspace, {
                backgroundColor: '#ffffff',
                scale: 2, // Mayor calidad
                useCORS: true,
                allowTaint: true,
                scrollX: 0,
                scrollY: 0,
                width: workspace.offsetWidth,
                height: workspace.offsetHeight,
                ignoreElements: (element) => {
                    // Ignorar elementos que no queremos en la exportación
                    return element.classList.contains('connection-label') &&
                        element.style.display === 'none';
                }
            }).then(canvas => {
                // Crear y descargar la imagen
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');

                link.download = `graphus_diagram_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');

                // Simular click para descargar
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                hideExportLoader();
                showNotification('Imagen PNG descargada exitosamente', 'success');

            }).catch(error => {
                console.error('Error al exportar:', error);
                hideExportLoader();
                showNotification('Error al generar la imagen PNG', 'error');
            });
        }

        /**
         * Exporta el área de trabajo como imagen JPG
         */
        function exportWorkspaceAsJPG() {
            const workspace = document.getElementById('workspaceArea');

            if (!workspace) {
                showNotification('No se encontró el área de trabajo', 'error');
                return;
            }

            const entities = workspace.querySelectorAll('.er-element');
            const connections = workspace.querySelectorAll('.connections-layer line');

            if (entities.length === 0 && connections.length === 0) {
                showNotification('No hay contenido para exportar', 'warning');
                return;
            }

            showExportLoader('Generando imagen JPG...');

            html2canvas(workspace, {
                backgroundColor: '#ffffff',
                scale: 2,
                useCORS: true,
                allowTaint: true,
                scrollX: 0,
                scrollY: 0,
                width: workspace.offsetWidth,
                height: workspace.offsetHeight
            }).then(canvas => {
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');

                link.download = `graphus_diagram_${timestamp}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                hideExportLoader();
                showNotification('Imagen JPG descargada exitosamente', 'success');

            }).catch(error => {
                console.error('Error al exportar:', error);
                hideExportLoader();
                showNotification('Error al generar la imagen JPG', 'error');
            });
        }

        /**
         * Exporta el área de trabajo como SVG
         */
        function exportWorkspaceAsSVG() {
            const workspace = document.getElementById('workspaceArea');

            if (!workspace) {
                showNotification('No se encontró el área de trabajo', 'error');
                return;
            }

            const entities = workspace.querySelectorAll('.er-element');
            const connections = workspace.querySelectorAll('.connections-layer line');

            if (entities.length === 0 && connections.length === 0) {
                showNotification('No hay contenido para exportar', 'warning');
                return;
            }

            showExportLoader('Generando imagen SVG...');

            try {
                // Crear SVG manualmente
                const svgContent = generateSVGContent(workspace, entities, connections);

                // Crear blob y descargar
                const blob = new Blob([svgContent], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');

                link.download = `graphus_diagram_${timestamp}.svg`;
                link.href = url;

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                URL.revokeObjectURL(url);
                hideExportLoader();
                showNotification('Imagen SVG descargada exitosamente', 'success');

            } catch (error) {
                console.error('Error al exportar SVG:', error);
                hideExportLoader();
                showNotification('Error al generar la imagen SVG', 'error');
            }
        }

        /**
         * Genera el contenido SVG del workspace
         */
        function generateSVGContent(workspace, entities, connections) {
            const width = workspace.offsetWidth;
            const height = workspace.offsetHeight;

            let svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
    <rect width="100%" height="100%" fill="white"/>
    
    <!-- Grid Pattern -->
    <defs>
        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#e5e7eb" stroke-width="0.5"/>
        </pattern>
    </defs>
    <rect width="100%" height="100%" fill="url(#grid)"/>
`;

            // Agregar conexiones
            connections.forEach(connection => {
                const x1 = connection.getAttribute('x1');
                const y1 = connection.getAttribute('y1');
                const x2 = connection.getAttribute('x2');
                const y2 = connection.getAttribute('y2');
                const stroke = connection.getAttribute('stroke') || '#333';
                const strokeWidth = connection.getAttribute('stroke-width') || '2';

                svgContent += `    <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="${stroke}" stroke-width="${strokeWidth}"/>
`;
            });

            // Agregar entidades (convertidas a texto)
            entities.forEach(entity => {
                const rect = entity.getBoundingClientRect();
                const workspaceRect = workspace.getBoundingClientRect();

                const x = rect.left - workspaceRect.left;
                const y = rect.top - workspaceRect.top;

                const table = entity.querySelector('table');
                if (table) {
                    svgContent += convertTableToSVG(table, x, y);
                }
            });

            svgContent += '</svg>';
            return svgContent;
        }

        /**
         * Convierte una tabla HTML a elementos SVG
         */
        function convertTableToSVG(table, offsetX, offsetY) {
            const rows = table.querySelectorAll('tr');
            let svg = '';
            let currentY = offsetY;

            rows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('th, td');
                let currentX = offsetX;
                const cellHeight = 25;

                cells.forEach((cell, cellIndex) => {
                    const cellWidth = 100; // Ancho fijo para simplicidad
                    const text = cell.textContent.trim();
                    const isHeader = cell.tagName === 'TH';

                    // Rectángulo de la celda
                    svg += `    <rect x="${currentX}" y="${currentY}" width="${cellWidth}" height="${cellHeight}" 
                       fill="${isHeader ? '#f3f4f6' : 'white'}" stroke="#111" stroke-width="1"/>
`;

                    // Texto de la celda
                    svg += `    <text x="${currentX + cellWidth / 2}" y="${currentY + cellHeight / 2 + 4}" 
                       text-anchor="middle" font-family="Arial" font-size="11" 
                       ${isHeader ? 'font-weight="bold"' : ''} fill="#000">${text}</text>
`;

                    currentX += cellWidth;
                });

                currentY += cellHeight;
            });

            return svg;
        }

        /**
         * Muestra el loader de exportación
         */
        function showExportLoader(message) {
            // Remover loader existente
            const existingLoader = document.getElementById('exportLoader');
            if (existingLoader) {
                existingLoader.remove();
            }

            const loader = document.createElement('div');
            loader.id = 'exportLoader';
            loader.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]';
            loader.innerHTML = `
        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm mx-4">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <div>
                    <div class="font-semibold text-gray-900">Exportando...</div>
                    <div class="text-sm text-gray-600">${message}</div>
                </div>
            </div>
        </div>
    `;

            document.body.appendChild(loader);
        }

        /**
         * Oculta el loader de exportación
         */
        function hideExportLoader() {
            const loader = document.getElementById('exportLoader');
            if (loader) {
                loader.remove();
            }
        }

        /**
         * Inicializa los event listeners para la exportación
         */
        function initializeExportListeners() {
            // Esperar a que el DOM esté listo
            document.addEventListener('DOMContentLoaded', function () {
                addExportEventListeners();
            });

            // Si el DOM ya está listo, ejecutar inmediatamente
            if (document.readyState !== 'loading') {
                addExportEventListeners();
            }
        }

        /**
         * Agrega los event listeners a los botones de exportación
         */
        function addExportEventListeners() {
            // Usar delegación de eventos para manejar contenido dinámico
            document.addEventListener('click', function (e) {
                // Verificar si el click fue en el contenedor de exportación de imagen
                const exportImageContainer = e.target.closest('.p-3.border.border-gray-200.rounded-lg');

                if (exportImageContainer) {
                    const iconElement = exportImageContainer.querySelector('.fa-image');
                    const titleElement = exportImageContainer.querySelector('.font-medium');

                    // Verificar si es el botón de exportar imagen
                    if (iconElement && titleElement && titleElement.textContent.includes('Exportar como Imagen')) {
                        e.preventDefault();
                        showImageExportModal();
                        return;
                    }
                }
            });
        }

        /**
         * Muestra el modal de selección de formato de imagen
         */
        function showImageExportModal() {
            // Remover modal existente
            const existingModal = document.getElementById('imageExportModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = 'imageExportModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]';
            modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 shadow-2xl max-w-md mx-4 transform scale-100">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-image text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Exportar como Imagen</h3>
                <p class="text-gray-600">Selecciona el formato de imagen que deseas descargar</p>
            </div>
            
            <div class="space-y-3 mb-6">
                <button onclick="exportWorkspaceAsPNG(); closeImageExportModal();" 
                        class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 text-left group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">PNG</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">Formato PNG</div>
                            <div class="text-sm text-gray-500">Mejor calidad, fondo transparente</div>
                        </div>
                        <i class="fas fa-download text-gray-400 group-hover:text-blue-500"></i>
                    </div>
                </button>
                
                <button onclick="exportWorkspaceAsJPG(); closeImageExportModal();" 
                        class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 text-left group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">JPG</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">Formato JPG</div>
                            <div class="text-sm text-gray-500">Menor tamaño, fondo blanco</div>
                        </div>
                        <i class="fas fa-download text-gray-400 group-hover:text-blue-500"></i>
                    </div>
                </button>
                
                <button onclick="exportWorkspaceAsSVG(); closeImageExportModal();" 
                        class="w-full p-4 border-2 border-gray-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 text-left group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg flex items-center justify-center">
                            <span class="text-white font-bold text-sm">SVG</span>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-900">Formato SVG</div>
                            <div class="text-sm text-gray-500">Vector escalable, editable</div>
                        </div>
                        <i class="fas fa-download text-gray-400 group-hover:text-blue-500"></i>
                    </div>
                </button>
            </div>
            
            <div class="flex space-x-3">
                <button onclick="closeImageExportModal();" 
                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancelar
                </button>
            </div>
        </div>
    `;

            document.body.appendChild(modal);

            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    closeImageExportModal();
                }
            });
        }

        /**
         * Cierra el modal de exportación de imagen
         */
        function closeImageExportModal() {
            const modal = document.getElementById('imageExportModal');
            if (modal) {
                modal.style.transform = 'scale(0.95)';
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 200);
            }
        }

        // ===== CARGAR LIBRERÍAS NECESARIAS =====

        /**
         * Carga la librería html2canvas si no está disponible
         */
        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (window.html2canvas) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('No se pudo cargar html2canvas'));
                document.head.appendChild(script);
            });
        }

        // ===== INICIALIZACIÓN =====

        // Cargar html2canvas y inicializar listeners
        loadHtml2Canvas().then(() => {
            console.log('html2canvas cargado correctamente');
            initializeExportListeners();
        }).catch(error => {
            console.error('Error cargando html2canvas:', error);
            showNotification('Error cargando librería de exportación', 'error');
        });

        // Hacer las funciones disponibles globalmente
        window.exportWorkspaceAsPNG = exportWorkspaceAsPNG;
        window.exportWorkspaceAsJPG = exportWorkspaceAsJPG;
        window.exportWorkspaceAsSVG = exportWorkspaceAsSVG;
        window.closeImageExportModal = closeImageExportModal;
    </script>
    <script>
        /*! export-sql-txt.js
     *  Añade la opción de "Exportar Código SQL → Script completo" y un botón
     *  "Exportar TXT" que generan el SQL desde el diagrama actual y lo descargan
     *  como .txt con nombre GraphUS_Diagrama_fecha.txt — sin tocar tu código existente.
     */
        (function () {
            // --- utils ---
            function slugify(s) {
                return String(s || 'proyecto')
                    .normalize('NFKD').replace(/[\u0300-\u036f]/g, '')
                    .toLowerCase().trim()
                    .replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
            }
            function getProjectName() {
                const byId = document.querySelector('#projectName')?.value;
                const byData = document.querySelector('[data-project-name]')?.getAttribute('data-project-name')
                    || document.querySelector('[data-project]')?.getAttribute('data-project');
                const byTitle = document.querySelector('.project-title')?.textContent
                    || document.querySelector('.brand-title')?.textContent
                    || document.title;
                return (byId || byData || byTitle || 'proyecto').trim();
            }
            function yyyy_mm_dd(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            }
            function notify(msg, type) {
                if (typeof window.showNotification === 'function') {
                    window.showNotification(msg, type || 'info');
                } else {
                    console.log(`[${type || 'info'}] ${msg}`);
                }
            }

            // --- lectura del diagrama -> SQL (fallback si no existe generateSQL) ---
            function normalizeType(t) {
                let dataType = String(t || '').trim();
                if (!dataType) dataType = 'VARCHAR(255)';
                dataType = dataType.replace(/INTEGER/gi, 'INT')
                    .replace(/NUMBER/gi, 'INT')
                    .replace(/STRING/gi, 'VARCHAR(255)');
                if (/^TEXT$/i.test(dataType)) dataType = 'TEXT';
                if (/^DATE$/i.test(dataType)) dataType = 'DATE';
                if (/^DECIMAL$/i.test(dataType)) dataType = 'DECIMAL(10,2)';
                return dataType;
            }
            function getTableNameFromEntity(entity) {
                // th suele contener el nombre de la entidad
                const thName = entity.querySelector('th')?.textContent?.trim();
                if (thName) return thName;
                // fallback: cabecera con .entity-name, si existiera
                const head = entity.querySelector('.entity-name')?.textContent?.trim();
                if (head) return head;
                return `tabla_${Math.random().toString(36).slice(2, 7)}`;
            }
            function findPrimaryKeyField(entity) {
                const rows = entity.querySelectorAll('tbody tr');
                for (const row of rows) {
                    const tds = row.querySelectorAll('td');
                    if (tds.length >= 2 && tds[0].querySelector('.fa-key')) {
                        return tds[1].textContent.trim().toLowerCase();
                    }
                }
                return 'id';
            }
            function findForeignKeyField(entity, referencedTableName) {
                const rows = entity.querySelectorAll('tbody tr');
                const ref = (referencedTableName || '').toLowerCase();
                for (const row of rows) {
                    const tds = row.querySelectorAll('td');
                    if (tds.length >= 2) {
                        const keyCell = tds[0];
                        const nameCell = tds[1];
                        const fieldName = nameCell.textContent.trim().toLowerCase();
                        if (
                            keyCell.querySelector('.fa-external-link-alt') ||
                            fieldName.includes(ref) ||
                            fieldName === `id_${ref}` ||
                            fieldName === `${ref}_id` ||
                            fieldName === `id${ref}` ||
                            fieldName === `${ref}id`
                        ) return fieldName;
                    }
                }
                return null;
            }
            function buildSQLFromDOM() {
                const ws = document.getElementById('workspaceArea');
                if (!ws) return '';
                const entities = ws.querySelectorAll('.er-element');
                const sql = [];
                entities.forEach(entity => {
                    const tableName = getTableNameFromEntity(entity).toLowerCase().replace(/\s+/g, '_');
                    const rows = entity.querySelectorAll('tbody tr');
                    const fieldLines = [];
                    const pks = [];
                    rows.forEach(row => {
                        const tds = row.querySelectorAll('td');
                        if (!tds.length) return;
                        let fieldName = null;
                        let dataType = 'VARCHAR(255)';
                        let isPK = false;
                        if (tds.length === 1) {
                            fieldName = tds[0].textContent.trim();
                        } else if (tds.length === 2) {
                            if (tds[0].querySelector('.fa-key')) {
                                isPK = true;
                                fieldName = tds[1].textContent.trim();
                            } else {
                                fieldName = tds[0].textContent.trim();
                                dataType = tds[1].textContent.trim() || dataType;
                            }
                        } else {
                            if (tds[0].querySelector('.fa-key')) {
                                isPK = true;
                                fieldName = tds[1].textContent.trim();
                                dataType = tds[2].textContent.trim() || dataType;
                            } else {
                                fieldName = tds[0].textContent.trim();
                                dataType = tds[1].textContent.trim() || dataType;
                            }
                        }
                        if (!fieldName) return;
                        let line = `  ${fieldName.toLowerCase()} ${normalizeType(dataType)}`;
                        if (isPK) {
                            line += ' PRIMARY KEY';
                            if (/INT/i.test(dataType)) line += ' AUTO_INCREMENT';
                            pks.push(fieldName.toLowerCase());
                        } else {
                            const n = fieldName.toLowerCase();
                            if (/(nombre|email|titulo|fecha|monto)/.test(n)) line += ' NOT NULL';
                        }
                        fieldLines.push(line);
                    });
                    sql.push(`CREATE TABLE ${tableName} (\n${fieldLines.join(',\n')}\n);\n`);
                });
                // Relaciones 1:N con allConnections si existen
                if (Array.isArray(window.allConnections) && window.allConnections.length) {
                    sql.push('-- Foreign Keys');
                    const added = {};
                    window.allConnections.forEach(conn => {
                        const table1 = conn.table1?.querySelector('th')?.textContent?.trim().toLowerCase();
                        const tableN = conn.tableN?.querySelector('th')?.textContent?.trim().toLowerCase();
                        if (!table1 || !tableN) return;
                        const fkField = findForeignKeyField(conn.tableN, table1) || `${table1}_id`;
                        const pkField = findPrimaryKeyField(conn.table1) || 'id';
                        const cname = `fk_${tableN}_${table1}`;
                        if (added[cname]) return;
                        sql.push(`ALTER TABLE ${tableN}\n  ADD CONSTRAINT ${cname}\n  FOREIGN KEY (${fkField}) REFERENCES ${table1}(${pkField});\n`);
                        added[cname] = true;
                    });
                }
                return sql.join('\n');
            }

            // --- export main ---
            function buildSQLFromDiagramSafe() {
                // Intenta usar tu generateSQL (si existe) para mantener coherencia
                try {
                    if (typeof window.generateSQL === 'function') {
                        window.generateSQL();
                        const editor = document.getElementById('sqlEditor');
                        const txt = editor && editor.value ? editor.value.trim() : '';
                        if (txt) return txt;
                    }
                } catch (e) {
                    console.warn('generateSQL falló, uso fallback DOM:', e);
                }
                // Fallback: construir directo del DOM
                return buildSQLFromDOM();
            }

            function exportSQLTxt() {
                const sql = buildSQLFromDiagramSafe();
                if (!sql || !sql.trim()) {
                    notify('No se pudo generar el SQL desde el diagrama', 'error');
                    return;
                }
                // Cambio aquí: nombre fijo "GraphUS_Diagrama" + fecha
                const fileName = `GraphUs - Creación de diagramas ER${yyyy_mm_dd(new Date())}.txt`;
                const blob = new Blob([sql], { type: 'text/plain;charset=utf-8' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(a.href);
                notify(`SQL descargado: ${fileName}`, 'success');
            }

            // --- UI hooks ---
            function injectSQLTxtButton() {
                const editor = document.getElementById('sqlEditor');
                if (!editor) return;
                // Buscar una toolbar cercana (la que contiene "Copiar" y "Descargar")
                const card = editor.closest('[class*="shadow"]') || editor.parentElement;
                if (!card) return;
                const candidateToolbars = card.querySelectorAll('.flex, .space-x-2, .gap-2');
                let toolbar = null;
                candidateToolbars.forEach(el => {
                    if (/Copiar|Descargar/i.test(el.textContent)) toolbar = el;
                });
                const container = toolbar || (card.querySelector('.flex') || card);
                if (!container || container.querySelector('#btnExportSqlTxt')) return;
                const btn = document.createElement('button');
                btn.id = 'btnExportSqlTxt';
                btn.type = 'button';
                btn.className = 'px-3 py-1.5 rounded-xl border border-gray-300 hover:bg-gray-100 text-sm';
                btn.innerHTML = '<i class="fas fa-file-export mr-2"></i>Exportar TXT';
                btn.addEventListener('click', exportSQLTxt);
                container.appendChild(btn);
            }

            function hookRightPanelExport() {
                // Delegación global: cuando se muestre el panel "Exportar", capturar clic
                document.addEventListener('click', function (e) {
                    const card = e.target.closest('.cursor-pointer, .p-3, .rounded-xl');
                    if (!card) return;
                    const text = card.textContent || '';
                    // Detecta específicamente el bloque "Exportar Código SQL" > "Script completo de la base de datos"
                    if (/Exportar Código SQL/i.test(text) && /Script completo/i.test(text)) {
                        exportSQLTxt();
                    }
                });
            }

            // Observa cambios en el DOM para reinyectar el botón si cambian vistas
            const mo = new MutationObserver(() => injectSQLTxtButton());
            window.addEventListener('DOMContentLoaded', () => {
                injectSQLTxtButton();
                hookRightPanelExport();
                const root = document.body;
                mo.observe(root, { childList: true, subtree: true });
            });

            // Dejar disponible global para llamadas manuales
            window.exportSQLTxt = exportSQLTxt;
        })();
    </script>
    <script>
        /*! export-doc-pdf.js
         * Crea un PDF con (1) imagen del diagrama y (2) código SQL completo.
         * No modifica tus funciones existentes. Se integra con la tarjeta
         * "Exportar Documentación — PDF con diagramas y código".
         */
        (function () {
            // ====== Helpers de entorno ======
            function notify(msg, type) {
                if (typeof window.showNotification === 'function') {
                    window.showNotification(msg, type || 'info');
                } else {
                    console.log(`[${type || 'info'}] ${msg}`);
                }
            }
            function showLoader(msg) {
                if (typeof window.showExportLoader === 'function') {
                    window.showExportLoader(msg || 'Generando PDF.');
                } else {
                    console.log('[loader] ' + (msg || 'Generando PDF.'));
                }
            }
            function hideLoader() {
                if (typeof window.hideExportLoader === 'function') {
                    window.hideExportLoader();
                }
            }
            function yyyy_mm_dd(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            }
            function getProjectName() {
                const byId = document.querySelector('#projectName')?.value;
                const byData = document.querySelector('[data-project-name]')?.getAttribute('data-project-name')
                    || document.querySelector('[data-project]')?.getAttribute('data-project');
                const byTitle = document.querySelector('.project-title')?.textContent
                    || document.querySelector('.brand-title')?.textContent
                    || document.title;
                return (byId || byData || byTitle || 'Proyecto').trim();
            }

            // ====== Cargadores de libs ======
            function loadHtml2CanvasIfNeeded() {
                return new Promise((resolve, reject) => {
                    if (window.html2canvas) return resolve();
                    const s = document.createElement('script');
                    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                    s.onload = resolve;
                    s.onerror = () => reject(new Error('No se pudo cargar html2canvas'));
                    document.head.appendChild(s);
                });
            }
            function loadJsPDFIfNeeded() {
                return new Promise((resolve, reject) => {
                    if (window.jspdf || (window.jsPDF && typeof window.jsPDF === 'function')) return resolve();
                    const s = document.createElement('script');
                    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                    s.onload = resolve;
                    s.onerror = () => reject(new Error('No se pudo cargar jsPDF'));
                    document.head.appendChild(s);
                });
            }

            // ====== Captura de imagen del diagrama (reutiliza tu enfoque actual) ======
            async function captureWorkspaceAsDataURL() {
                const workspace = document.getElementById('workspaceArea');
                if (!workspace) throw new Error('No se encontró el área de trabajo');

                const entities = workspace.querySelectorAll('.er-element');
                const connections = workspace.querySelectorAll('.connections-layer line');
                if (entities.length === 0 && connections.length === 0) {
                    throw new Error('No hay contenido para exportar');
                }

                await loadHtml2CanvasIfNeeded(); // ya lo usas para PNG/JPG/SVG
                const canvas = await html2canvas(workspace, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0,
                    width: workspace.offsetWidth,
                    height: workspace.offsetHeight
                });
                return canvas.toDataURL('image/png');
            }

            // ====== Obtención de SQL (1º intenta tu generateSQL, 2º fallback DOM) ======
            function normalizeType(t) {
                let dataType = String(t || '').trim();
                if (!dataType) dataType = 'VARCHAR(255)';
                dataType = dataType.replace(/INTEGER/gi, 'INT')
                    .replace(/NUMBER/gi, 'INT')
                    .replace(/STRING/gi, 'VARCHAR(255)');
                if (/^TEXT$/i.test(dataType)) dataType = 'TEXT';
                if (/^DATE$/i.test(dataType)) dataType = 'DATE';
                if (/^DECIMAL$/i.test(dataType)) dataType = 'DECIMAL(10,2)';
                return dataType;
            }
            function findPrimaryKeyField(entityEl) {
                // icono de llave o texto con "PK" en la fila
                const rows = entityEl.querySelectorAll('tr');
                for (const tr of rows) {
                    const hasKeyIcon = tr.querySelector('.fa-key');
                    const txt = tr.textContent || '';
                    if (hasKeyIcon || /\bPK\b|PRIMARY KEY/i.test(txt)) {
                        const td = tr.querySelector('td, th');
                        if (td) return td.textContent.trim().toLowerCase();
                    }
                }
                // fallback típico
                return 'id';
            }
            function findForeignKeyField(entityWrapper, referencedName) {
                const name = String(referencedName || '').toLowerCase();
                const candidates = [
                    `${name}_id`, `${name}Id`, `${name}_fk`, `id_${name}`, `fk_${name}`
                ];
                const rows = entityWrapper.querySelectorAll('tr');
                for (const tr of rows) {
                    const td = tr.querySelector('td, th');
                    const colName = td?.textContent?.trim() || '';
                    if (!colName) continue;
                    if (candidates.includes(colName) || new RegExp(`${name}.*id`, 'i').test(colName)) {
                        return colName;
                    }
                }
                return null;
            }
            function buildSQLFromDOM() {
                const ws = document.getElementById('workspaceArea');
                const entities = Array.from(ws.querySelectorAll('.er-element'));
                if (!entities.length) return '';

                const sql = [];
                entities.forEach(wrapper => {
                    const tableEl = wrapper.querySelector('table');
                    if (!tableEl) return;

                    const thName = tableEl.querySelector('th')?.textContent?.trim() ||
                        wrapper.querySelector('th')?.textContent?.trim() || 'tabla';
                    const tableName = thName.trim().toLowerCase().replace(/\s+/g, '_');

                    const fields = [];
                    tableEl.querySelectorAll('tr').forEach(tr => {
                        const cells = tr.querySelectorAll('td, th');
                        if (!cells.length) return;
                        const colName = (cells[0].textContent || '').trim();
                        if (!colName) return;
                        let typeTxt = (cells[1]?.textContent || '').trim();
                        typeTxt = normalizeType(typeTxt);
                        let line = `  ${colName} ${typeTxt}`;
                        const txt = tr.textContent || '';
                        if (/\bPK\b|PRIMARY KEY/i.test(txt)) line += ' PRIMARY KEY';
                        if (/\bNN\b|NOT NULL/i.test(txt)) line += ' NOT NULL';
                        fields.push(line);
                    });
                    if (fields.length) {
                        sql.push(`CREATE TABLE ${tableName} (\n${fields.join(',\n')}\n);\n`);
                    }
                });

                // Relaciones 1:N si existen (usa window.allConnections que ya mantienes)
                if (Array.isArray(window.allConnections) && window.allConnections.length) {
                    sql.push('-- Foreign Keys');
                    const added = {};
                    window.allConnections.forEach(conn => {
                        const table1 = conn.table1?.querySelector('th')?.textContent?.trim().toLowerCase();
                        const tableN = conn.tableN?.querySelector('th')?.textContent?.trim().toLowerCase();
                        if (!table1 || !tableN) return;
                        const fkField = findForeignKeyField(conn.tableN, table1) || `${table1}_id`;
                        const pkField = findPrimaryKeyField(conn.table1) || 'id';
                        const cname = `fk_${tableN}_${table1}`;
                        if (added[cname]) return;
                        sql.push(`ALTER TABLE ${tableN}\n  ADD CONSTRAINT ${cname}\n  FOREIGN KEY (${fkField}) REFERENCES ${table1}(${pkField});\n`);
                        added[cname] = true;
                    });
                }
                return sql.join('\n');
            }
            function getDiagramSQL() {
                try {
                    if (typeof window.generateSQL === 'function') {
                        window.generateSQL(); // tu función ya llena #sqlEditor
                        const editor = document.getElementById('sqlEditor');
                        const txt = editor && editor.value ? editor.value.trim() : '';
                        if (txt) return txt;
                    }
                } catch (e) {
                    console.warn('generateSQL falló, se usará fallback DOM:', e);
                }
                return buildSQLFromDOM();
            }

            // ====== Generación del PDF (jsPDF) ======
            async function exportDiagramAndSQLToPDF() {
                try {
                    showLoader('Capturando diagrama e incrustando SQL.');
                    await loadJsPDFIfNeeded();

                    // UMD build de jsPDF
                    const { jsPDF } = window.jspdf || window;

                    // 1) Capturar imagen del diagrama
                    const imgDataUrl = await captureWorkspaceAsDataURL();

                    // 2) Obtener SQL
                    const sql = getDiagramSQL();
                    if (!sql || !sql.trim()) {
                        hideLoader();
                        notify('No se pudo generar el SQL desde el diagrama', 'error');
                        return;
                    }

                    // 3) Armar PDF
                    const doc = new jsPDF({ unit: 'pt', format: 'a4' }); // 595x842 pt
                    const pageW = doc.internal.pageSize.getWidth();
                    const pageH = doc.internal.pageSize.getHeight();
                    const margin = 40;

                    // Portada + imagen
                    const title = 'Documentación de Diagrama ER';
                    const proj = getProjectName();
                    const dateStr = yyyy_mm_dd(new Date());

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(16);
                    doc.text(title, margin, margin + 10);

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(11);
                    doc.text(`Proyecto: ${proj}`, margin, margin + 30);
                    doc.text(`Fecha: ${dateStr}`, margin, margin + 46);

                    // Insertar imagen ajustada al ancho disponible
                    const imgMaxW = pageW - margin * 2;
                    const img = new Image();
                    img.src = imgDataUrl;
                    // Para mantener la relación de aspecto, medimos con un canvas virtual
                    // (jsPDF no conoce el tamaño real hasta dibujar; usamos truco de Image)
                    await new Promise(res => { img.onload = res; img.onerror = res; });
                    const ratio = img.width ? (img.height / img.width) : 0.6; // fallback ratio
                    const imgW = imgMaxW;
                    const imgH = imgW * ratio;

                    let y = margin + 70;
                    if (y + imgH > pageH - margin) {
                        doc.addPage();
                        y = margin;
                    }
                    doc.addImage(imgDataUrl, 'PNG', margin, y, imgW, imgH);

                    // 4) Nueva(s) página(s) con SQL
                    doc.addPage();
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.text('Script SQL', margin, margin);

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    const textW = pageW - margin * 2;
                    const lines = doc.splitTextToSize(sql, textW);

                    let cursorY = margin + 20;
                    const lineHeight = 13;

                    lines.forEach(line => {
                        if (cursorY + lineHeight > pageH - margin) {
                            doc.addPage();
                            cursorY = margin;
                        }
                        doc.text(line, margin, cursorY);
                        cursorY += lineHeight;
                    });

                    // 5) Descargar
                    const fileName = `GraphUs - Documentación ER ${dateStr}.pdf`;
                    doc.save(fileName);

                    hideLoader();
                    notify(`PDF generado: ${fileName}`, 'success');
                } catch (err) {
                    console.error(err);
                    hideLoader();
                    notify('Ocurrió un error al generar el PDF', 'error');
                }
            }

            // ====== Hook con tu tarjeta "Exportar Documentación" ======
            function hookExportDocumentationCard() {
                document.addEventListener('click', function (e) {
                    const card = e.target.closest('.p-3.border.border-gray-200.rounded-lg');
                    if (!card) return;
                    const isDocCard =
                        /Exportar Documentación/i.test(card.textContent || '') &&
                        /PDF con diagramas y código/i.test(card.textContent || '');
                    if (isDocCard) {
                        e.preventDefault();
                        exportDiagramAndSQLToPDF();
                    }
                });
            }

            // Init
            window.addEventListener('DOMContentLoaded', () => {
                hookExportDocumentationCard();
            });

            // Exponer global por si quieres llamarlo manualmente
            window.exportDiagramAndSQLToPDF = exportDiagramAndSQLToPDF;
        })();
    </script>


</body>

</html>